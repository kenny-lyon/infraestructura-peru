<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFRAESTRUCTURA PORTUARIA, AEROPORTUARIA Y FERROVIARIA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a1a2f;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden; /* Permite scroll vertical, oculta solo horizontal */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }

        .map-header {
            padding: 20px;
            background: linear-gradient(45deg, #4a90e2, #5ba3f5);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #map {
            height: 500px;
            width: 100%;
        }

        .stats-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            max-height: 580px;
            overflow-y: auto;
        }

        .stats-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .stats-header h3 {
            color: #4a90e2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4a90e2;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4a90e2;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }

        .details-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .details-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            margin: 20px 0;
        }
        
        .chart-container-small {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        
        .chart-container-small canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        .chart-placeholder {
            height: 300px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1rem;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: white;
            color: #4a90e2;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #4a90e2;
            color: white;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: #4a90e2;
            color: white;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #666;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #eee;
            border-top: 2px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design Mejorado */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .advanced-filters {
                padding: 15px !important;
            }
            
            .advanced-filters > div {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 8px !important;
            }
            
            .advanced-filters input, .advanced-filters select {
                width: 100% !important;
                box-sizing: border-box;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .filters {
                justify-content: center;
            }
            
            .filter-btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            
            .advanced-filters {
                margin-bottom: 15px !important;
                padding: 12px !important;
            }
            
            .advanced-filters h4 {
                font-size: 1.1rem !important;
                margin-bottom: 12px !important;
            }
            
            /* Ocultar algunos elementos en m√≥vil */
            .advanced-filters label {
                display: none !important;
            }
            
            /* Stack todos los botones */
            .advanced-filters > div {
                flex-wrap: wrap !important;
            }
            
            /* Mejorar el panel de estad√≠sticas en m√≥vil */
            #estadisticasAvanzadas > div {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 5px !important;
            }
            
            #estadisticasAvanzadas > div > div {
                padding: 6px !important;
                font-size: 0.8rem !important;
            }
            
            /* Hacer el mapa m√°s peque√±o en m√≥vil */
            #map {
                height: 350px !important;
            }
            
            /* Mejorar stats panel en m√≥vil */
            .stats-panel {
                max-height: none !important;
                padding: 15px !important;
            }
            
            .metric-card {
                padding: 12px !important;
                margin-bottom: 10px !important;
            }
            
            .metric-value {
                font-size: 1.5rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .filter-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            /* Hacer botones de export m√°s peque√±os */
            .advanced-filters .filter-btn {
                padding: 6px 8px !important;
                font-size: 0.7rem !important;
            }
            
            /* Una sola columna para estad√≠sticas en m√≥viles muy peque√±os */
            #estadisticasAvanzadas > div {
                grid-template-columns: 1fr !important;
            }
            
            /* Reducir padding en contenedores */
            .advanced-panel {
                padding: 15px 10px 10px 10px !important;
                margin-bottom: 20px !important;
            }
            
            /* Mejorar el header del dashboard */
            .dashboard-header {
                flex-direction: column !important;
                text-align: center !important;
                gap: 10px;
            }
            
            .dashboard-header h1 {
                font-size: 1.3rem;
            }
            
            /* Admin settings m√°s peque√±o en m√≥vil */
            .admin-settings {
                width: 40px !important;
                height: 40px !important;
                font-size: 1.4rem !important;
                top: 15px !important;
                right: 15px !important;
            }
        }

        .popup-custom {
            font-family: 'Segoe UI', sans-serif;
        }

        .popup-title {
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 8px;
        }

        .popup-info {
            color: #666;
            line-height: 1.4;
        }

        .advanced-panel {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.10);
            padding: 25px 20px 20px 20px;
            margin-bottom: 35px;
            border-left: 6px solid #4a90e2;
        }
        .advanced-panel .stats-header {
            margin-bottom: 18px;
        }
        .advanced-panel input[type="text"] {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #b0b0b0;
            font-size: 1rem;
            outline: none;
            transition: border 0.2s;
        }
        .advanced-panel input[type="text"]:focus {
            border: 1.5px solid #4a90e2;
        }
        .advanced-panel .filter-btn {
            padding: 10px 22px;
            border-radius: 25px;
            background: #f5f7fa;
            color: #4a90e2;
            border: none;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(74,144,226,0.07);
            transition: background 0.2s, color 0.2s, transform 0.2s;
        }
        .advanced-panel .filter-btn:hover, .advanced-panel .filter-btn:focus {
            background: #4a90e2;
            color: #fff;
            transform: translateY(-2px) scale(1.04);
        }
        .advanced-panel .filter-btn.active {
            background: #4a90e2;
            color: #fff;
        }
        .advanced-panel .loading, .advanced-panel .error {
            margin: 18px 0 0 0;
            font-size: 1.1rem;
            text-align: center;
        }
        .advanced-panel .loading {
            color: #4a90e2;
        }
        .advanced-panel .error {
            color: #f44336;
        }
        .advanced-panel table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px;
            background: #f9fafd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(74,144,226,0.07);
        }
        .advanced-panel th, .advanced-panel td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
            font-size: 0.98rem;
        }
        .advanced-panel th {
            background: #eaf1fb;
            color: #4a90e2;
            font-weight: 700;
        }
        .advanced-panel tr:last-child td {
            border-bottom: none;
        }
        .advanced-panel td.icon-cell {
            text-align: center;
            font-size: 1.2rem;
        }
        @media (max-width: 900px) {
            .advanced-panel table, .advanced-panel thead, .advanced-panel tbody, .advanced-panel th, .advanced-panel td, .advanced-panel tr {
                display: block;
            }
            .advanced-panel th {
                position: absolute;
                left: -9999px;
            }
            .advanced-panel td {
                border: none;
                position: relative;
                padding-left: 50%;
                min-height: 38px;
            }
            .advanced-panel td:before {
                position: absolute;
                left: 10px;
                top: 10px;
                white-space: nowrap;
                font-weight: bold;
                color: #4a90e2;
            }
        }
        /* Estilos para la tabla de cercanos */
        .cercanos-table-container {
            margin: 18px 0 0 0;
            background: #f9fafd;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(74,144,226,0.07);
            padding: 18px 12px 12px 12px;
            max-width: 500px;
        }
        .cercanos-table-title {
            text-align: center;
            color: #4a90e2;
            font-size: 1.15rem;
            font-weight: bold;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }
        .cercanos-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .cercanos-table th, .cercanos-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            font-size: 1rem;
        }
        .cercanos-table th {
            background: #eaf1fb;
            color: #4a90e2;
            font-weight: 700;
        }
        .cercanos-table tr:last-child td {
            border-bottom: none;
        }
        .cercanos-table tr:hover {
            background: #f0f6ff;
        }
        /* Fondo de estrellas y canvas animado */
        #stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100%;
            min-height: 100vh;
            pointer-events: none;
            z-index: 0;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite alternate;
            opacity: 0.8;
        }
        @keyframes twinkle {
            0% { opacity: 0.2; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .star:nth-child(2n) { width: 2px; height: 2px; animation-duration: 2s; }
        .star:nth-child(3n) { width: 3px; height: 3px; animation-duration: 4s; }
        .star:nth-child(4n) { width: 1px; height: 1px; animation-duration: 3.5s; }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        /* Asegura que el contenido principal est√© por encima del fondo animado */
        .container, .connection-status, .leaflet-control, .leaflet-top, .leaflet-bottom {
            position: relative;
            z-index: 2;
        }
        /* Bot√≥n de configuraci√≥n de administrador */
        .admin-settings {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 20;
            background: rgba(44, 62, 80, 0.92);
            color: #fff;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            cursor: pointer;
            font-size: 1.7rem;
            transition: background 0.2s, transform 0.2s;
        }
        .admin-settings:hover {
            background: #4a90e2;
            color: #fff;
            transform: rotate(30deg) scale(1.08);
        }
    </style>
</head>
<body>
    <div id="stars"></div>
    <canvas id="canvas"></canvas>
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i> Conectado a MongoDB
    </div>
    <div class="admin-settings" onclick="window.location.href='login_admin.html'" title="Configuraci√≥n de Administrador">
        <i class="fas fa-cog"></i>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-globe-americas"></i> INFRAESTRUCTURA PORTUARIA, AEROPORTUARIA Y FERROVIARIA</h1>
            <p>An√°lisis interactivo de puertos, aeropuertos y ferrov√≠as del Per√∫</p>
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="filtrarPor('todos')">
                <i class="fas fa-globe"></i> Todos
            </button>
            <button class="filter-btn" onclick="filtrarPor('puerto')">
                <i class="fas fa-ship"></i> Puertos
            </button>
            <button class="filter-btn" onclick="filtrarPor('aeropuerto')">
                <i class="fas fa-plane"></i> Aeropuertos
            </button>
            <button class="filter-btn" onclick="filtrarPor('ferroviaria')">
                <i class="fas fa-train"></i> Ferroviarias
            </button>
        </div>

        <!-- Filtros Avanzados Mejorados -->
        <div class="advanced-filters" style="margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8;">
            <h4 style="margin-bottom: 15px; color: #17a2b8;"><i class="fas fa-filter"></i> Filtros Avanzados</h4>
            
            <!-- Fila 1: Filtros b√°sicos -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px;">
                <div style="position: relative;">
                    <input type="text" id="autocompleteNombre" placeholder="üîç Buscar por nombre..." 
                           style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd; width: 250px;"
                           oninput="mostrarSugerenciasNombre(this.value)" onfocus="mostrarSugerenciasNombre(this.value)">
                    <div id="sugerenciasNombre" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 6px; max-height: 200px; overflow-y: auto; width: 100%; z-index: 1000; display: none;"></div>
                </div>
                
                <select id="filtroDepartamento" onchange="aplicarFiltrosAvanzados()" style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd;">
                    <option value="">üåç Todos los departamentos</option>
                </select>
                
                <select id="filtroEstado" onchange="aplicarFiltrosAvanzados()" style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd;">
                    <option value="">üìä Todos los estados</option>
                    <option value="Operativo">‚úÖ Operativo</option>
                    <option value="Inoperativo">‚ùå Inoperativo</option>
                    <option value="En construcci√≥n">üöß En construcci√≥n</option>
                </select>
                
                <select id="filtroTitularidad" onchange="aplicarFiltrosAvanzados()" style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd;">
                    <option value="">üè¢ Todas las titularidades</option>
                    <option value="P√∫blica">üèõÔ∏è P√∫blica</option>
                    <option value="Privada">üè≠ Privada</option>
                    <option value="Mixta">ü§ù Mixta</option>
                </select>
            </div>
            
            <!-- Fila 2: Filtros geogr√°ficos -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label style="font-weight: bold; color: #666;">üìç Coordenadas:</label>
                    <input type="number" id="latMin" placeholder="Lat Min" step="0.001" onchange="aplicarFiltrosAvanzados()" style="width: 80px; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                    <input type="number" id="latMax" placeholder="Lat Max" step="0.001" onchange="aplicarFiltrosAvanzados()" style="width: 80px; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                    <input type="number" id="lngMin" placeholder="Lng Min" step="0.001" onchange="aplicarFiltrosAvanzados()" style="width: 80px; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                    <input type="number" id="lngMax" placeholder="Lng Max" step="0.001" onchange="aplicarFiltrosAvanzados()" style="width: 80px; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                    <button onclick="usarViewActual()" class="filter-btn" style="background: #28a745; color: white; padding: 6px 10px;">
                        <i class="fas fa-crosshairs"></i> Usar Vista
                    </button>
                </div>
                
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label style="font-weight: bold; color: #666;">üéØ Proximidad:</label>
                    <input type="text" id="puntoReferencia" placeholder="Punto de referencia" style="width: 150px; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                    <input type="number" id="radioKm" placeholder="Radio (km)" min="1" style="width: 80px; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                    <button onclick="buscarPorProximidad()" class="filter-btn" style="background: #fd7e14; color: white; padding: 6px 10px;">
                        <i class="fas fa-bullseye"></i> Buscar
                    </button>
                </div>
                
                <!-- Herramientas de dibujo -->
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label style="font-weight: bold; color: #666;">üñçÔ∏è Dibujar √Åreas:</label>
                    <button onclick="toggleModoAreaDrawing()" class="filter-btn" style="background: #e83e8c; color: white; padding: 6px 10px;" id="btnDibujar">
                        <i class="fas fa-draw-polygon"></i> Activar Dibujo
                    </button>
                    <button onclick="limpiarAreasDibujadas()" class="filter-btn" style="background: #6c757d; color: white; padding: 6px 10px;">
                        <i class="fas fa-eraser"></i> Limpiar √Åreas
                    </button>
                </div>
            </div>
            
            <!-- Fila 3: Filtros m√∫ltiples y acciones -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <div style="position: relative;">
                    <input type="text" id="multiDepartamentos" placeholder="üåê M√∫ltiples departamentos..." readonly
                           style="padding: 8px 12px; border-radius: 6px; border: 2px solid #ddd; width: 200px; cursor: pointer;"
                           onclick="toggleMultiSelect('departamentos')">
                    <div id="multiSelectDepartamentos" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 6px; max-height: 200px; overflow-y: auto; width: 100%; z-index: 1000; display: none; padding: 10px;"></div>
                </div>
                
                <button onclick="aplicarFiltrosAvanzados()" class="filter-btn" style="background: #17a2b8; color: white;">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
                <button onclick="limpiarFiltrosAvanzados()" class="filter-btn" style="background: #6c757d; color: white;">
                    <i class="fas fa-eraser"></i> Limpiar Todo
                </button>
                <button onclick="guardarFiltrosFavoritos()" class="filter-btn" style="background: #ffc107; color: black;">
                    <i class="fas fa-star"></i> Guardar
                </button>
                <select id="filtrosFavoritos" onchange="cargarFiltroFavorito()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="">‚≠ê Filtros Favoritos</option>
                </select>
                
                <!-- Botones de Export -->
                <div style="display: flex; gap: 5px; margin-left: 10px;">
                    <button onclick="exportarDatos('csv')" class="filter-btn" style="background: #28a745; color: white; padding: 8px 12px;">
                        <i class="fas fa-download"></i> CSV
                    </button>
                    <button onclick="exportarDatos('json')" class="filter-btn" style="background: #007bff; color: white; padding: 8px 12px;">
                        <i class="fas fa-download"></i> JSON
                    </button>
                    <button onclick="exportarDatos('kml')" class="filter-btn" style="background: #6f42c1; color: white; padding: 8px 12px;">
                        <i class="fas fa-map"></i> KML
                    </button>
                </div>
            </div>
            
            <!-- Informaci√≥n de resultados con estad√≠sticas avanzadas -->
            <div id="infoFiltros" style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #0066cc; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div><strong>üìä Resultados:</strong> <span id="contadorFiltros">0</span> registros encontrados</div>
                    <button onclick="toggleEstadisticasAvanzadas()" class="filter-btn" style="background: #17a2b8; color: white; padding: 4px 8px; font-size: 0.8rem;">
                        <i class="fas fa-chart-line"></i> Stats
                    </button>
                </div>
                
                <!-- Estad√≠sticas avanzadas -->
                <div id="estadisticasAvanzadas" style="display: none; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px;">
                            <div style="font-weight: bold; color: #007bff;" id="statPuertos">0</div>
                            <div style="font-size: 0.8rem;">üö¢ Puertos</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px;">
                            <div style="font-weight: bold; color: #fd7e14;" id="statAeropuertos">0</div>
                            <div style="font-size: 0.8rem;">‚úàÔ∏è Aeropuertos</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px;">
                            <div style="font-weight: bold; color: #8B4513;" id="statFerroviarias">0</div>
                            <div style="font-size: 0.8rem;">üöÇ Ferroviarias</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px;">
                            <div style="font-weight: bold; color: #28a745;" id="statDepartamentos">0</div>
                            <div style="font-size: 0.8rem;">üó∫Ô∏è Departamentos</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px;">
                            <div style="font-weight: bold; color: #6c757d;" id="statOperativos">0</div>
                            <div style="font-size: 0.8rem;">‚úÖ Operativos</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px;">
                            <div style="font-weight: bold; color: #dc3545;" id="statInoperativos">0</div>
                            <div style="font-size: 0.8rem;">‚ùå Inoperativos</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Historial de b√∫squedas -->
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>üïê Historial de B√∫squedas</strong>
                    <button onclick="limpiarHistorial()" class="filter-btn" style="background: #6c757d; color: white; padding: 4px 8px; font-size: 0.8rem;">
                        <i class="fas fa-trash"></i> Limpiar
                    </button>
                </div>
                <div id="historialBusquedas" style="margin-top: 10px; max-height: 100px; overflow-y: auto;">
                    <div style="color: #666; font-size: 0.9rem;">No hay b√∫squedas recientes</div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="map-container">
                <div class="map-header">
                    <i class="fas fa-map-marked-alt"></i>
                    <h3>Mapa Interactivo</h3>
                </div>
                <div id="map"></div>
            </div>

            <div class="stats-panel">
                <div class="stats-header">
                    <h3><i class="fas fa-chart-bar"></i> Estad√≠sticas Generales</h3>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value" id="totalPuertos">12</div>
                    <div class="metric-label">Total Puertos</div>
                </div>

                <div class="metric-card">
                    <div class="metric-value" id="totalAeropuertos">8</div>
                    <div class="metric-label">Total Aeropuertos</div>
                </div>

                <div class="metric-card">
                    <div class="metric-value" id="totalFerroviarias">0</div>
                    <div class="metric-label">Total Ferroviarias</div>
                </div>

                <div class="metric-card">
                    <div class="metric-value" id="departamentos">15</div>
                    <div class="metric-label">Departamentos Cubiertos</div>
                </div>

                <div class="metric-card">
                    <div class="metric-value" id="movimientoCarga">2.4M</div>
                    <div class="metric-label">Toneladas/A√±o</div>
                </div>

                <div class="loading" id="loadingStats">
                    <div class="spinner"></div>
                    Cargando datos de MongoDB...
                </div>
            </div>
        </div>

        <!-- Consultas avanzadas -->
        <div class="advanced-panel">
            <div class="stats-header">
                <h3><i class="fas fa-search"></i> Consultas Avanzadas</h3>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <input type="text" id="busquedaInput" placeholder="Buscar por nombre o c√≥digo..." style="padding:8px 12px;border-radius:5px;border:1px solid #ccc;">
                <button onclick="buscarNombre()" class="filter-btn"><i class="fas fa-search"></i> Buscar</button>
                <button onclick="consultaStat('departamentos')" class="filter-btn">Por Departamento</button>
                <button onclick="consultaStat('estados')" class="filter-btn">Por Estado</button>
                <button onclick="consultaStat('administradores')" class="filter-btn">Por Titularidad</button>
                <button onclick="consultaStat('tipos')" class="filter-btn">Por Tipo</button>
                <button onclick="consultaStat('coordenadas')" class="filter-btn">Validar Coordenadas</button>
                <button onclick="refrescarMapa()" class="filter-btn" style="background:#eee;color:#333;"><i class="fas fa-sync"></i> Refrescar</button>
            </div>
            
            <!-- Controles de Carga Optimizada -->
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px;border-left:4px solid #28a745;">
                <div style="display:flex;gap:8px;align-items:center;">
                    <button onclick="cargarDatos(1, 100, false)" class="filter-btn" style="background:#17a2b8;color:white;">
                        <i class="fas fa-list"></i> Cargar Paginado (100)
                    </button>
                    <button onclick="cargarMasDatos()" class="filter-btn" style="background:#6c757d;color:white;" id="btnCargarMas">
                        <i class="fas fa-plus"></i> Cargar M√°s
                    </button>
                    <button onclick="confirmarCargarTodo()" class="filter-btn" style="background:#dc3545;color:white;">
                        <i class="fas fa-exclamation-triangle"></i> Cargar TODO (‚ö†Ô∏è Lento)
                    </button>
                    <button onclick="limpiarDatos()" class="filter-btn" style="background:#6f42c1;color:white;">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
                <div id="infoRegistros" style="color:#666;font-size:0.9rem;margin-left:auto;">
                    Registros cargados: 0
                </div>
            </div>
            <div id="resultadoConsulta" style="margin-top:20px;"></div>
        </div>

        <!-- Panel de Funcionalidades Avanzadas -->
        <div class="advanced-panel">
            <div class="stats-header">
                <h3><i class="fas fa-cogs"></i> Funcionalidades Avanzadas de BD</h3>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                <button onclick="ejecutarTransaccion()" class="filter-btn" style="background:#28a745;color:white;">
                    <i class="fas fa-exchange-alt"></i> Ejecutar Transacci√≥n
                </button>
                <button onclick="validarIntegridad()" class="filter-btn" style="background:#ffc107;color:black;">
                    <i class="fas fa-check-circle"></i> Validar Integridad
                </button>
                <button onclick="generarBackup()" class="filter-btn" style="background:#17a2b8;color:white;">
                    <i class="fas fa-download"></i> Generar Backup
                </button>
                <button onclick="medirRendimiento()" class="filter-btn" style="background:#6f42c1;color:white;">
                    <i class="fas fa-tachometer-alt"></i> Medir Rendimiento
                </button>
                <button onclick="verProcedimientos()" class="filter-btn" style="background:#fd7e14;color:white;">
                    <i class="fas fa-code"></i> Ver Procedimientos
                </button>
                <button onclick="mostrarLogs()" class="filter-btn" style="background:#6c757d;color:white;">
                    <i class="fas fa-file-alt"></i> Logs Sistema
                </button>
            </div>
            <div id="resultadoAvanzado" style="margin-top:20px;"></div>
        </div>

        <div class="details-panel" id="detailsPanel">
            <div class="stats-header">
                <h3 id="selectedTitle"><i class="fas fa-info-circle"></i> Detalles del Terminal</h3>
            </div>
            
            <div id="selectedInfo">
                <p>Selecciona un puerto o aeropuerto en el mapa para ver estad√≠sticas detalladas.</p>
            </div>

            <!-- Informaci√≥n de terminales cercanos -->
            <div id="chartContainer"></div>
            
            <!-- Gr√°ficos estad√≠sticos (colapsables) -->
            <div style="margin-top: 20px;">
                <button onclick="toggleGraficos()" class="filter-btn" style="background: #17a2b8; color: white; width: 100%;">
                    <i class="fas fa-chart-bar"></i> <span id="toggleGraficosText">Mostrar Gr√°ficos Estad√≠sticos</span>
                </button>
                
                <div id="graficosContainer" style="display: none; margin-top: 15px;">
                    <div class="chart-container-small">
                        <h4 style="text-align: center; color: #4a90e2; margin-bottom: 10px;">Top Departamentos</h4>
                        <canvas id="chartPorDepartamento" style="max-height: 250px;"></canvas>
                    </div>
                    
                    <div class="chart-container-small">
                        <h4 style="text-align: center; color: #4a90e2; margin-bottom: 10px;">Por Tipo</h4>
                        <canvas id="chartPorTipo" style="max-height: 200px;"></canvas>
                    </div>
                    
                    <div class="chart-container-small">
                        <h4 style="text-align: center; color: #4a90e2; margin-bottom: 10px;">Por Estado</h4>
                        <canvas id="chartPorEstado" style="max-height: 200px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        // Inicializaci√≥n del mapa
        const mapa = L.map('map').setView([-9.19, -75.0152], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(mapa);

        let datosCompletos = [];
        let datosOriginales = [];
        let marcadores = [];
        let lineasFerroviarias = [];
        let filtroActivo = 'todos';
        
        // Paleta de colores extendida
        const colores = {
            primario: '#4a90e2',
            secundario: '#5ba3f5',
            puerto: '#2196F3',
            aeropuerto: '#FF9800',
            ferroviaria: '#8B4513',
            exito: '#4CAF50',
            advertencia: '#FFC107',
            peligro: '#F44336',
            info: '#17a2b8',
            gradientes: [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
            ]
        };

        // Iconos personalizados
        const iconoPuerto = L.divIcon({
            html: '<i class="fas fa-ship" style="color: #2196F3; font-size: 20px;"></i>',
            iconSize: [30, 30],
            className: 'custom-div-icon'
        });
        const iconoAeropuerto = L.divIcon({
            html: '<i class="fas fa-plane" style="color: #FF9800; font-size: 20px;"></i>',
            iconSize: [30, 30],
            className: 'custom-div-icon'
        });
        const iconoFerroviaria = L.divIcon({
            html: '<i class="fas fa-train" style="color: #8B4513; font-size: 20px;"></i>',
            iconSize: [30, 30],
            className: 'custom-div-icon'
        });

        // Variables de paginaci√≥n
        let paginaActual = 1;
        const limitePorPagina = 100; // Por defecto cargar solo 100 registros
        let cargarTodoActivado = false;
        
        // Cargar datos con paginaci√≥n optimizada
        async function cargarDatos(pagina = 1, limite = limitePorPagina, cargarTodo = false) {
            try {
                // Mostrar indicador de carga
                document.getElementById('loadingStats').style.display = 'flex';
                document.getElementById('loadingStats').innerHTML = '<div class="spinner"></div>' + 
                    (cargarTodo ? 'Cargando TODOS los datos (puede ser lento)...' : `Cargando p√°gina ${pagina}...`);
                
                const params = new URLSearchParams();
                if (!cargarTodo) {
                    params.append('limit', limite);
                    params.append('offset', (pagina - 1) * limite);
                }
                params.append('cargar_todo', cargarTodo ? '1' : '0');
                
                const res = await fetch(`api_puntos.php?${params}`);
                const data = await res.json();
                datosCompletos = data.map(item => {
                    let nombre = item.NOMBRE || item.nombre || '';
                    let departamento = '';
                    if (item.tipo === 'puerto') {
                        departamento = (item.LOCALIDAD || '').trim();
                    } else {
                        departamento = (item.DEPARTAMENTO || '').trim();
                    }
                    
                    // Normalizar algunos departamentos comunes con variaciones
                    departamento = normalizarDepartamento(departamento);
                    let lat = parseFloat(item.LATITUD);
                    let lng = parseFloat(item.LONGITUD);
                    
                    // Para ferroviarias, usar coordenadas si est√°n disponibles
                    if (item.tipo === 'ferroviaria' && !lat && !lng) {
                        // Asignar coordenadas por defecto para ferroviarias sin coordenadas
                        lat = -12.0464; // Lima por defecto
                        lng = -77.0428;
                    }
                    
                    return {
                        tipo: item.tipo,
                        nombre,
                        departamento,
                        lat,
                        lng,
                        raw: item
                    };
                });
                
                // Solo actualizar datosOriginales si es carga completa
                if (cargarTodo || pagina === 1) {
                    datosOriginales = [...datosCompletos];
                } else {
                    // Para p√°ginas adicionales, agregar a los datos existentes
                    datosOriginales = [...datosOriginales, ...datosCompletos];
                    datosCompletos = [...datosOriginales];
                }
                
                cargarTodoActivado = cargarTodo;
                paginaActual = pagina;
                
                cargarMarcadores();
                actualizarEstadisticas();
                document.getElementById('loadingStats').style.display = 'none';
                
                // Actualizar controles de paginaci√≥n
                actualizarControlesPaginacion(data.length, cargarTodo);
            } catch (e) {
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-times-circle"></i> Error de conexi√≥n a MongoDB';
                document.getElementById('loadingStats').innerHTML = 'Error al cargar datos.';
            }
        }

        // Funci√≥n para limpiar l√≠neas ferroviarias
        function limpiarLineasFerroviarias() {
            lineasFerroviarias.forEach(linea => mapa.removeLayer(linea));
            lineasFerroviarias = [];
        }

        // Funci√≥n optimizada para cargar marcadores con clustering
        function cargarMarcadores() {
            // Limpiar marcadores existentes
            marcadores.forEach(marker => mapa.removeLayer(marker));
            marcadores = [];
            limpiarLineasFerroviarias();
            
            // Filtrar datos seg√∫n criterios activos
            const datosFiltrados = datosCompletos.filter(terminal => 
                (filtroActivo === 'todos' || filtroActivo === terminal.tipo) && 
                !isNaN(terminal.lat) && !isNaN(terminal.lng)
            );
            
            // Si hay demasiados marcadores, usar clustering visual
            const MAX_MARCADORES_INDIVIDUALES = 500;
            
            if (datosFiltrados.length > MAX_MARCADORES_INDIVIDUALES) {
                cargarMarcadoresConClustering(datosFiltrados);
            } else {
                cargarMarcadoresIndividuales(datosFiltrados);
            }
            
            // Mostrar informaci√≥n de rendimiento
            document.getElementById('infoRegistros').innerHTML += ` | Marcadores en mapa: ${marcadores.length}`;
        }
        
        // Cargar marcadores individuales (para datasets peque√±os)
        function cargarMarcadoresIndividuales(datos) {
            datos.forEach(terminal => {
                const icono = terminal.tipo === 'puerto' ? iconoPuerto : 
                             (terminal.tipo === 'aeropuerto' ? iconoAeropuerto : iconoFerroviaria);
                const tipoTexto = terminal.tipo === 'puerto' ? 'Puerto' : 
                                 (terminal.tipo === 'aeropuerto' ? 'Aeropuerto' : 'Ferroviaria');
                
                const marker = L.marker([terminal.lat, terminal.lng], { icon: icono })
                    .addTo(mapa)
                    .bindPopup(`
                        <div class="popup-custom">
                            <div class="popup-title">${terminal.nombre}</div>
                            <div class="popup-info">
                                <strong>Departamento/Localidad:</strong> ${terminal.departamento}<br>
                                <strong>Tipo:</strong> ${tipoTexto}
                            </div>
                        </div>
                    `)
                    .on('click', () => mostrarDetalles(terminal));
                marcadores.push(marker);
            });
        }
        
        // Cargar marcadores con clustering simple (para datasets grandes)
        function cargarMarcadoresConClustering(datos) {
            const gridSize = 0.1; // Aproximadamente 10km
            const clusters = {};
            
            // Agrupar puntos por proximidad
            datos.forEach(terminal => {
                const clusterKey = `${Math.floor(terminal.lat / gridSize)}_${Math.floor(terminal.lng / gridSize)}`;
                if (!clusters[clusterKey]) {
                    clusters[clusterKey] = [];
                }
                clusters[clusterKey].push(terminal);
            });
            
            // Crear marcadores por cluster
            Object.values(clusters).forEach(cluster => {
                if (cluster.length === 1) {
                    // Marcador individual
                    const terminal = cluster[0];
                    const icono = terminal.tipo === 'puerto' ? iconoPuerto : 
                                 (terminal.tipo === 'aeropuerto' ? iconoAeropuerto : iconoFerroviaria);
                    const marker = L.marker([terminal.lat, terminal.lng], { icon: icono })
                        .addTo(mapa)
                        .bindPopup(`<div class="popup-custom">
                            <div class="popup-title">${terminal.nombre}</div>
                            <div class="popup-info">
                                <strong>Departamento:</strong> ${terminal.departamento}<br>
                                <strong>Tipo:</strong> ${terminal.tipo}
                            </div>
                        </div>`)
                        .on('click', () => mostrarDetalles(terminal));
                    marcadores.push(marker);
                } else {
                    // Marcador de cluster
                    const centerLat = cluster.reduce((sum, t) => sum + t.lat, 0) / cluster.length;
                    const centerLng = cluster.reduce((sum, t) => sum + t.lng, 0) / cluster.length;
                    const tiposPorCluster = [...new Set(cluster.map(t => t.tipo))];
                    
                    const clusterIcon = L.divIcon({
                        html: `<div style="background: #4a90e2; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${cluster.length}</div>`,
                        iconSize: [40, 40],
                        className: 'cluster-icon'
                    });
                    
                    const marker = L.marker([centerLat, centerLng], { icon: clusterIcon })
                        .addTo(mapa)
                        .bindPopup(`<div class="popup-custom">
                            <div class="popup-title">Cluster de ${cluster.length} puntos</div>
                            <div class="popup-info">
                                <strong>Tipos:</strong> ${tiposPorCluster.join(', ')}<br>
                                <strong>Zoom para ver detalles</strong>
                            </div>
                        </div>`);
                    marcadores.push(marker);
                }
            });
        }

        // Funci√≥n para filtrar
        function filtrarPor(tipo) {
            filtroActivo = tipo;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            cargarMarcadores();
            actualizarEstadisticas();
        }

        // Funci√≥n mejorada para dibujar tramo espec√≠fico
        async function dibujarTramoEspecifico(nombreFerrocarril, tramoEspecifico, codigoFerroviario = '') {
            try {
                limpiarLineasFerroviarias();
                
                // Construir URL con par√°metros adicionales para mejor precisi√≥n
                let url = `api_tramos_ferroviarios.php?nombre=${encodeURIComponent(nombreFerrocarril)}&tramo=${encodeURIComponent(tramoEspecifico)}`;
                if (codigoFerroviario) {
                    url += `&codigo=${encodeURIComponent(codigoFerroviario)}`;
                }
                
                const response = await fetch(url);
                const tramoData = await response.json();
                
                if (tramoData.error) {
                    console.error('Error cargando tramo espec√≠fico:', tramoData.error);
                    alert(`Error: ${tramoData.error}`);
                    return;
                }
                
                if (tramoData.puntos && tramoData.puntos.length > 0) {
                    const color = '#D2691E'; // Color naranja para tramos espec√≠ficos
                    
                    // SIEMPRE intentar dibujar l√≠nea, incluso con un solo punto
                    if (tramoData.puntos.length === 1) {
                        // Para un solo punto, crear una l√≠nea corta indicativa
                        const punto = tramoData.puntos[0];
                        const puntoExtendido = [
                            [punto[0] - 0.01, punto[1] - 0.01], // Punto inicial
                            punto, // Punto central (real)
                            [punto[0] + 0.01, punto[1] + 0.01]  // Punto final
                        ];
                        
                        const polyline = L.polyline(puntoExtendido, {
                            color: color,
                            weight: 6,
                            opacity: 0.8,
                            dashArray: '10, 5'
                        }).addTo(mapa);
                        
                        lineasFerroviarias.push(polyline);
                        
                        polyline.bindPopup(`
                            <div style="font-family: Arial; text-align: center;">
                                <h4 style="color: ${color};">üöÇ ${tramoData.nombre}</h4>
                                <p><strong>Tramo:</strong> ${tramoData.tramo}</p>
                                <p><strong>Tipo:</strong> Segmento √∫nico</p>
                                <p><strong>Longitud estimada:</strong> ${tramoData.info[0]?.longitud || 'N/A'} km</p>
                            </div>
                        `);
                        
                        // Centrar vista en el punto
                        mapa.setView(punto, 12);
                        
                    } else {
                        // Para m√∫ltiples puntos, optimizar el trazado
                        const puntosOrdenados = optimizarRutaFerroviaria(tramoData.puntos);
                        
                        const polyline = L.polyline(puntosOrdenados, {
                            color: color,
                            weight: 5,
                            opacity: 0.9,
                            smoothFactor: 1.0
                        }).addTo(mapa);
                        
                        lineasFerroviarias.push(polyline);
                        
                        // Calcular distancia total
                        const distanciaTotal = calcularDistanciaPolyline(puntosOrdenados);
                        const longitud_total = tramoData.info.reduce((sum, seg) => sum + (seg.longitud || 0), 0);
                        
                        polyline.bindPopup(`
                            <div style="font-family: Arial; text-align: center;">
                                <h4 style="color: ${color};">üöÇ ${tramoData.nombre}</h4>
                                <p><strong>Tramo:</strong> ${tramoData.tramo}</p>
                                <p><strong>Puntos:</strong> ${tramoData.puntos.length}</p>
                                <p><strong>Longitud oficial:</strong> ${longitud_total.toFixed(1)} km</p>
                                <p><strong>Distancia estimada:</strong> ${distanciaTotal.toFixed(1)} km</p>
                            </div>
                        `);
                        
                        // Ajustar vista al tramo completo
                        mapa.fitBounds(polyline.getBounds(), { padding: [20, 20] });
                    }
                    
                    // Agregar marcadores en estaciones principales
                    const puntosImportantes = tramoData.info.filter((seg, index) => 
                        index === 0 || index === tramoData.info.length - 1 || seg.estado === 'Operativo'
                    );
                    
                    puntosImportantes.forEach((segmento, index) => {
                        const esTerminal = index === 0 || index === puntosImportantes.length - 1;
                        const iconHtml = esTerminal 
                            ? '<i class="fas fa-train" style="color: ' + color + '; font-size: 14px;"></i>'
                            : '<i class="fas fa-circle" style="color: ' + color + '; font-size: 8px;"></i>';
                        
                        const marker = L.marker([segmento.lat, segmento.lng], {
                            icon: L.divIcon({
                                html: iconHtml,
                                iconSize: esTerminal ? [20, 20] : [12, 12],
                                className: 'custom-div-icon'
                            })
                        }).addTo(mapa);
                        
                        marker.bindPopup(`
                            <div style="max-width: 200px;">
                                <strong>${segmento.subtramo || 'Estaci√≥n'}</strong><br>
                                <strong>Tramo:</strong> ${segmento.tramo || tramoData.tramo}<br>
                                <strong>Longitud:</strong> ${segmento.longitud || 0} km<br>
                                <strong>Estado:</strong> ${segmento.estado || 'N/A'}<br>
                                <strong>Administrador:</strong> ${segmento.administrador || 'N/A'}
                            </div>
                        `);
                        
                        lineasFerroviarias.push(marker);
                    });
                    
                    console.log(`üöÇ Tramo espec√≠fico dibujado: ${tramoData.tramo} con ${tramoData.puntos.length} puntos`);
                    
                    // Mostrar notificaci√≥n de √©xito
                    mostrarNotificacion(`Tramo "${tramoData.tramo}" dibujado correctamente`, 'success');
                }
                
            } catch (error) {
                console.error('Error dibujando tramo espec√≠fico:', error);
                mostrarNotificacion('Error al cargar el tramo ferroviario', 'error');
            }
        }
        
        // Funci√≥n auxiliar para optimizar ruta ferroviaria
        function optimizarRutaFerroviaria(puntos) {
            if (puntos.length <= 2) return puntos;
            
            // Ordenar puntos por proximidad geogr√°fica (algoritmo del vecino m√°s cercano simplificado)
            const puntosOrdenados = [puntos[0]]; // Empezar con el primer punto
            const puntosRestantes = puntos.slice(1);
            
            while (puntosRestantes.length > 0) {
                const ultimoPunto = puntosOrdenados[puntosOrdenados.length - 1];
                let indiceMasCercano = 0;
                let distanciaMinima = distanciaKm(ultimoPunto[0], ultimoPunto[1], 
                                                 puntosRestantes[0][0], puntosRestantes[0][1]);
                
                for (let i = 1; i < puntosRestantes.length; i++) {
                    const distancia = distanciaKm(ultimoPunto[0], ultimoPunto[1], 
                                                 puntosRestantes[i][0], puntosRestantes[i][1]);
                    if (distancia < distanciaMinima) {
                        distanciaMinima = distancia;
                        indiceMasCercano = i;
                    }
                }
                
                puntosOrdenados.push(puntosRestantes[indiceMasCercano]);
                puntosRestantes.splice(indiceMasCercano, 1);
            }
            
            return puntosOrdenados;
        }
        
        // Funci√≥n auxiliar para calcular distancia de polyline
        function calcularDistanciaPolyline(puntos) {
            let distanciaTotal = 0;
            for (let i = 0; i < puntos.length - 1; i++) {
                distanciaTotal += distanciaKm(puntos[i][0], puntos[i][1], puntos[i+1][0], puntos[i+1][1]);
            }
            return distanciaTotal;
        }
        
        // Funci√≥n auxiliar para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const colores = {
                'success': '#28a745',
                'error': '#dc3545',
                'info': '#17a2b8'
            };
            
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colores[tipo]};
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 10000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                max-width: 300px;
                font-family: Arial, sans-serif;
            `;
            notificacion.textContent = mensaje;
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.opacity = '0';
                notificacion.style.transition = 'opacity 0.5s';
                setTimeout(() => document.body.removeChild(notificacion), 500);
            }, 3000);
        }

        // Funci√≥n para dibujar tramo ferroviario completo
        async function dibujarTramoFerroviario(nombreFerrocarril) {
            try {
                limpiarLineasFerroviarias();
                
                const response = await fetch(`api_tramos_ferroviarios.php?nombre=${encodeURIComponent(nombreFerrocarril)}`);
                const tramoData = await response.json();
                
                if (tramoData.error) {
                    console.error('Error cargando tramo completo:', tramoData.error);
                    return;
                }
                
                if (tramoData.puntos && tramoData.puntos.length > 1) {
                    // Dibujar l√≠nea principal
                    const polyline = L.polyline(tramoData.puntos, {
                        color: '#8B4513',
                        weight: 4,
                        opacity: 0.8,
                        dashArray: '10, 5'
                    }).addTo(mapa);
                    
                    lineasFerroviarias.push(polyline);
                    
                    // Popup para la l√≠nea
                    const longitud_total = tramoData.info.reduce((sum, seg) => sum + seg.longitud, 0);
                    polyline.bindPopup(`
                        <div style="font-family: Arial; text-align: center;">
                            <h4 style="color: #8B4513;">üõ§Ô∏è ${tramoData.nombre}</h4>
                            <p><strong>Segmentos:</strong> ${tramoData.info.length}</p>
                            <p><strong>Longitud total:</strong> ${longitud_total.toFixed(2)} km</p>
                            <p><strong>Departamentos:</strong> ${[...new Set(tramoData.info.map(i => i.departamento))].join(', ')}</p>
                        </div>
                    `);
                    
                    // Agregar marcadores en puntos importantes
                    tramoData.info.forEach((segmento, index) => {
                        if (index % 3 === 0) { // Mostrar cada 3 segmentos para no saturar
                            const marker = L.marker([segmento.lat, segmento.lng], {
                                icon: L.divIcon({
                                    html: '<i class="fas fa-circle" style="color: #8B4513; font-size: 8px;"></i>',
                                    iconSize: [12, 12],
                                    className: 'custom-div-icon'
                                })
                            }).addTo(mapa);
                            
                            marker.bindPopup(`
                                <div>
                                    <strong>${segmento.subtramo}</strong><br>
                                    <strong>Tramo:</strong> ${segmento.tramo}<br>
                                    <strong>Longitud:</strong> ${segmento.longitud} km<br>
                                    <strong>Estado:</strong> ${segmento.estado}
                                </div>
                            `);
                            
                            lineasFerroviarias.push(marker);
                        }
                    });
                    
                    // Ajustar vista al tramo
                    mapa.fitBounds(polyline.getBounds());
                    
                    console.log(`üõ§Ô∏è Ferrocarril completo dibujado: ${tramoData.nombre} con ${tramoData.puntos.length} puntos`);
                }
                
            } catch (error) {
                console.error('Error dibujando ferrocarril completo:', error);
            }
        }

        // Funci√≥n para mostrar detalles
        function mostrarDetalles(terminal) {
            const panel = document.getElementById('detailsPanel');
            const titulo = document.getElementById('selectedTitle');
            const info = document.getElementById('selectedInfo');
            const icono = terminal.tipo === 'puerto' ? 'ship' : (terminal.tipo === 'aeropuerto' ? 'plane' : 'train');
            titulo.innerHTML = `<i class="fas fa-${icono}"></i> ${terminal.nombre}`;
            
            // Mostrar todos los datos disponibles
            let html = '';
            for (const [key, value] of Object.entries(terminal.raw)) {
                if (["LATITUD","LONGITUD","_id","tipo","id"].includes(key)) continue;
                html += `<div><strong>${key}:</strong> ${value}</div>`;
            }
            
            // Si es ferroviaria, agregar botones para dibujar tramo
            if (terminal.tipo === 'ferroviaria') {
                const tramo = terminal.raw.TRAMO || '';
                const subtramo = terminal.raw.SUBTRAMO || '';
                const nombre = terminal.raw.NOMBRE || '';
                const codigoFerroviario = terminal.raw.CODIGO_FERROVIARIO || '';
                
                html += `<div style="margin-top: 15px;">
                    <button onclick="dibujarTramoEspecifico('${nombre}', '${tramo}', '${codigoFerroviario}')" 
                            style="background: #8B4513; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">
                        üöÇ Dibujar Tramo
                    </button>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        <strong>Tramo:</strong> ${tramo}<br>
                        <strong>Subtramo:</strong> ${subtramo}<br>
                        <strong>C√≥digo:</strong> ${codigoFerroviario}
                    </div>
                </div>`;
            }
            
            info.innerHTML = html || '<p>No hay detalles disponibles.</p>';
            panel.classList.add('active');
            mostrarCercanos(terminal);
        }

        // Calcular distancia Haversine
        function distanciaKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Funci√≥n para mostrar/ocultar gr√°ficos
        function toggleGraficos() {
            const container = document.getElementById('graficosContainer');
            const texto = document.getElementById('toggleGraficosText');
            const isVisible = container.style.display !== 'none';
            
            if (isVisible) {
                container.style.display = 'none';
                texto.textContent = 'Mostrar Gr√°ficos Estad√≠sticos';
            } else {
                container.style.display = 'block';
                texto.textContent = 'Ocultar Gr√°ficos Estad√≠sticos';
                // Recrear gr√°ficos con tama√±o correcto
                setTimeout(() => crearGraficos(), 100);
            }
        }
        
        // Mostrar los 3 m√°s cercanos
        function mostrarCercanos(terminal) {
            const container = document.getElementById('chartContainer');
            if (isNaN(terminal.lat) || isNaN(terminal.lng)) {
                container.innerHTML = '<div style="color: #666; padding: 10px;">No hay datos de ubicaci√≥n para este punto.</div>';
                return;
            }
            // Filtrar solo del mismo tipo, pero diferente id
            const mismos = datosOriginales.filter(t => t.tipo === terminal.tipo && t.nombre !== terminal.nombre && !isNaN(t.lat) && !isNaN(t.lng));
            // Calcular distancias
            const cercanos = mismos.map(t => ({
                nombre: t.nombre,
                localidad: t.departamento,
                tipo: t.tipo,
                distancia: distanciaKm(terminal.lat, terminal.lng, t.lat, t.lng)
            }))
            .sort((a, b) => a.distancia - b.distancia)
            .slice(0, 3);
            if (!cercanos.length) {
                container.innerHTML = '<div class="error">No hay puntos cercanos para mostrar.</div>';
                return;
            }
            let html = '<div class="cercanos-table-container">';
            html += '<div class="cercanos-table-title">3 puntos m√°s cercanos</div>';
            html += '<div style="overflow-x:auto;"><table class="cercanos-table"><tr><th>Tipo</th><th>Nombre</th><th>Localidad</th><th>Distancia (km)</th></tr>';
            cercanos.forEach(c => {
                html += `<tr><td>${c.tipo === 'puerto' ? '‚õ¥Ô∏è Puerto' : '‚úàÔ∏è Aeropuerto'}</td><td>${c.nombre}</td><td>${c.localidad}</td><td>${c.distancia.toFixed(2)}</td></tr>`;
            });
            html += '</table></div></div>';
            container.innerHTML = html;
        }

        // Funci√≥n para actualizar estad√≠sticas
        function actualizarEstadisticas() {
            const datosFiltrados = datosCompletos.filter(t => 
                filtroActivo === 'todos' || filtroActivo === t.tipo
            );
            const puertos = datosFiltrados.filter(t => t.tipo === 'puerto').length;
            const aeropuertos = datosFiltrados.filter(t => t.tipo === 'aeropuerto').length;
            const ferroviarias = datosFiltrados.filter(t => t.tipo === 'ferroviaria').length;
            const departamentos = new Set(datosFiltrados.map(t => t.departamento)).size;
            document.getElementById('totalPuertos').textContent = puertos;
            document.getElementById('totalAeropuertos').textContent = aeropuertos;
            document.getElementById('totalFerroviarias').textContent = ferroviarias;
            document.getElementById('departamentos').textContent = departamentos;
            
            // Actualizar gr√°ficos si est√°n disponibles
            if (datosCompletos.length > 0) {
                crearGraficos();
            }
        }

        // Variables para gr√°ficos
        let chartDepartamentos = null;
        let chartTipos = null;
        let chartEstados = null;
        
        // Funci√≥n para crear gr√°ficos
        function crearGraficos() {
            // Limpiar gr√°ficos existentes
            if (chartDepartamentos) chartDepartamentos.destroy();
            if (chartTipos) chartTipos.destroy();
            if (chartEstados) chartEstados.destroy();
            
            // Gr√°fico por departamento
            const ctxDep = document.getElementById('chartPorDepartamento').getContext('2d');
            const departamentos = {};
            
            datosCompletos.forEach(item => {
                const dep = item.departamento || 'Sin departamento';
                if (!departamentos[dep]) departamentos[dep] = 0;
                departamentos[dep]++;
            });
            
            const topDepartamentos = Object.entries(departamentos)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            chartDepartamentos = new Chart(ctxDep, {
                type: 'bar',
                data: {
                    labels: topDepartamentos.map(([dept]) => dept),
                    datasets: [{
                        label: 'Cantidad',
                        data: topDepartamentos.map(([,count]) => count),
                        backgroundColor: colores.gradientes,
                        borderColor: colores.primario,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 9
                                },
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
            
            // Gr√°fico por tipo
            const ctxTipo = document.getElementById('chartPorTipo').getContext('2d');
            const tipos = {
                'Puerto': datosCompletos.filter(d => d.tipo === 'puerto').length,
                'Aeropuerto': datosCompletos.filter(d => d.tipo === 'aeropuerto').length,
                'Ferroviaria': datosCompletos.filter(d => d.tipo === 'ferroviaria').length
            };
            
            chartTipos = new Chart(ctxTipo, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tipos),
                    datasets: [{
                        data: Object.values(tipos),
                        backgroundColor: [colores.puerto, colores.aeropuerto, colores.ferroviaria]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                },
                                padding: 10
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
            
            // Gr√°fico por estado
            const ctxEstado = document.getElementById('chartPorEstado').getContext('2d');
            const estados = {};
            
            datosCompletos.forEach(item => {
                const estado = item.raw.ESTADO || 'Sin estado';
                if (!estados[estado]) estados[estado] = 0;
                estados[estado]++;
            });
            
            chartEstados = new Chart(ctxEstado, {
                type: 'pie',
                data: {
                    labels: Object.keys(estados),
                    datasets: [{
                        data: Object.values(estados),
                        backgroundColor: colores.gradientes
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 10
                                },
                                padding: 8
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Funci√≥n para poblar filtros
        function poblarFiltros() {
            const departamentos = [...new Set(datosOriginales
                .map(d => d.departamento)
                .filter(dep => dep && dep.trim() !== '') // Eliminar vac√≠os
            )].sort();
            const selectDep = document.getElementById('filtroDepartamento');
            
            departamentos.forEach(dep => {
                const option = document.createElement('option');
                option.value = dep;
                option.textContent = dep;
                selectDep.appendChild(option);
            });
        }
        
        // Variables para filtros avanzados
        let departamentosSeleccionados = [];
        let filtrosFavoritos = JSON.parse(localStorage.getItem('filtrosFavoritos') || '[]');
        let sugerenciasNombres = [];
        let historialBusquedas = JSON.parse(localStorage.getItem('historialBusquedas') || '[]');
        let areasMapaDibujadas = [];
        let modoAreaDrawing = false;
        
        // Funci√≥n para normalizar nombres de departamentos
        function normalizarDepartamento(dep) {
            if (!dep || dep.trim() === '') return '';
            
            dep = dep.trim();
            
            // Mapeo de variaciones comunes
            const mapeosDepartamentos = {
                'LIMA': 'LIMA',
                'LIMA METROPOLITANA': 'LIMA',
                'LIMA PROVINCIA': 'LIMA',
                'CALLAO': 'CALLAO',
                'PROV. CONST. DEL CALLAO': 'CALLAO',
                'PROVINCIA CONSTITUCIONAL DEL CALLAO': 'CALLAO',
                'CUSCO': 'CUSCO',
                'CUZCO': 'CUSCO',
                'AREQUIPA': 'AREQUIPA',
                'PIURA': 'PIURA',
                'TRUJILLO': 'LA LIBERTAD',
                'LA LIBERTAD': 'LA LIBERTAD',
                'ICA': 'ICA',
                'MOQUEGUA': 'MOQUEGUA',
                'TACNA': 'TACNA',
                'LAMBAYEQUE': 'LAMBAYEQUE',
                'CHICLAYO': 'LAMBAYEQUE',
                'TUMBES': 'TUMBES',
                'ANCASH': 'ANCASH',
                'HUARAZ': 'ANCASH',
                'JUNIN': 'JUN√çN',
                'JUN√çN': 'JUN√çN',
                'HUANCAYO': 'JUN√çN',
                'AYACUCHO': 'AYACUCHO',
                'HUANCAVELICA': 'HUANCAVELICA',
                'CAJAMARCA': 'CAJAMARCA',
                'AMAZONAS': 'AMAZONAS',
                'SAN MARTIN': 'SAN MART√çN',
                'SAN MART√çN': 'SAN MART√çN',
                'LORETO': 'LORETO',
                'UCAYALI': 'UCAYALI',
                'MADRE DE DIOS': 'MADRE DE DIOS',
                'HUANUCO': 'HU√ÅNUCO',
                'HU√ÅNUCO': 'HU√ÅNUCO',
                'PASCO': 'PASCO',
                'APURIMAC': 'APUR√çMAC',
                'APUR√çMAC': 'APUR√çMAC',
                'PUNO': 'PUNO'
            };
            
            // Buscar mapeo exacto (case insensitive)
            const depUpper = dep.toUpperCase();
            return mapeosDepartamentos[depUpper] || dep;
        }
        
        // Autocomplete para nombres
        function mostrarSugerenciasNombre(valor) {
            const contenedor = document.getElementById('sugerenciasNombre');
            
            if (valor.length < 2) {
                contenedor.style.display = 'none';
                return;
            }
            
            // Buscar coincidencias
            const coincidencias = datosOriginales
                .filter(item => item.nombre.toLowerCase().includes(valor.toLowerCase()))
                .map(item => ({ nombre: item.nombre, tipo: item.tipo, departamento: item.departamento }))
                .slice(0, 10);
            
            if (coincidencias.length === 0) {
                contenedor.style.display = 'none';
                return;
            }
            
            let html = '';
            coincidencias.forEach(item => {
                const icono = item.tipo === 'puerto' ? 'üö¢' : (item.tipo === 'aeropuerto' ? '‚úàÔ∏è' : 'üöÇ');
                html += `<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" 
                            onmouseover="this.style.background='#f0f6ff'" 
                            onmouseout="this.style.background='white'"
                            onclick="seleccionarSugerencia('${item.nombre}')">
                    ${icono} <strong>${item.nombre}</strong> - ${item.departamento}
                </div>`;
            });
            
            contenedor.innerHTML = html;
            contenedor.style.display = 'block';
        }
        
        function seleccionarSugerencia(nombre) {
            document.getElementById('autocompleteNombre').value = nombre;
            document.getElementById('sugerenciasNombre').style.display = 'none';
            aplicarFiltrosAvanzados();
        }
        
        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', function(e) {
            const autocomplete = document.getElementById('autocompleteNombre');
            const sugerencias = document.getElementById('sugerenciasNombre');
            if (!autocomplete.contains(e.target) && !sugerencias.contains(e.target)) {
                sugerencias.style.display = 'none';
            }
        });
        
        // Filtros por coordenadas
        function usarViewActual() {
            const bounds = mapa.getBounds();
            document.getElementById('latMin').value = bounds.getSouth().toFixed(3);
            document.getElementById('latMax').value = bounds.getNorth().toFixed(3);
            document.getElementById('lngMin').value = bounds.getWest().toFixed(3);
            document.getElementById('lngMax').value = bounds.getEast().toFixed(3);
            aplicarFiltrosAvanzados();
        }
        
        // B√∫squeda por proximidad
        async function buscarPorProximidad() {
            const puntoRef = document.getElementById('puntoReferencia').value;
            const radio = parseFloat(document.getElementById('radioKm').value);
            
            if (!puntoRef || !radio) {
                alert('Por favor ingresa un punto de referencia y radio');
                return;
            }
            
            // Buscar el punto de referencia en los datos
            const referencia = datosOriginales.find(item => 
                item.nombre.toLowerCase().includes(puntoRef.toLowerCase())
            );
            
            if (!referencia) {
                alert('No se encontr√≥ el punto de referencia');
                return;
            }
            
            // Filtrar por proximidad
            datosCompletos = datosOriginales.filter(item => {
                if (isNaN(item.lat) || isNaN(item.lng)) return false;
                const distancia = distanciaKm(referencia.lat, referencia.lng, item.lat, item.lng);
                return distancia <= radio;
            });
            
            cargarMarcadores();
            actualizarEstadisticas();
            actualizarContadorFiltros();
            
            // Centrar mapa en punto de referencia
            mapa.setView([referencia.lat, referencia.lng], 8);
            
            // Mostrar c√≠rculo del radio
            L.circle([referencia.lat, referencia.lng], {
                color: '#ff6b6b',
                fillColor: '#ff6b6b',
                fillOpacity: 0.1,
                radius: radio * 1000 // convertir a metros
            }).addTo(mapa);
        }
        
        // Multi-select para departamentos
        function toggleMultiSelect(tipo) {
            const contenedor = document.getElementById(`multiSelect${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            const isVisible = contenedor.style.display !== 'none';
            
            if (isVisible) {
                contenedor.style.display = 'none';
            } else {
                if (tipo === 'departamentos') {
                    poblarMultiSelectDepartamentos();
                }
                contenedor.style.display = 'block';
            }
        }
        
        function poblarMultiSelectDepartamentos() {
            // Los departamentos ya est√°n normalizados al cargar los datos
            const departamentos = [...new Set(datosOriginales
                .map(d => d.departamento)
                .filter(dep => dep && dep.trim() !== '') // Eliminar vac√≠os
            )].sort();
            
            // Debug opcional: descomentar para ver departamentos
            // console.log('Departamentos √∫nicos:', departamentos);
            
            const contenedor = document.getElementById('multiSelectDepartamentos');
            
            let html = '<div style="margin-bottom: 10px;"><strong>Seleccionar Departamentos:</strong></div>';
            departamentos.forEach(dep => {
                const checked = departamentosSeleccionados.includes(dep) ? 'checked' : '';
                html += `<label style="display: block; margin: 5px 0; cursor: pointer;">
                    <input type="checkbox" value="${dep}" ${checked} onchange="actualizarDepartamentosSeleccionados()"> 
                    ${dep}
                </label>`;
            });
            
            contenedor.innerHTML = html;
        }
        
        function actualizarDepartamentosSeleccionados() {
            const checkboxes = document.querySelectorAll('#multiSelectDepartamentos input[type="checkbox"]');
            departamentosSeleccionados = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            const input = document.getElementById('multiDepartamentos');
            input.value = departamentosSeleccionados.length > 0 
                ? `${departamentosSeleccionados.length} departamentos seleccionados`
                : '';
            
            aplicarFiltrosAvanzados();
        }
        
        // Aplicar filtros avanzados mejorado
        function aplicarFiltrosAvanzados() {
            const nombreBusqueda = document.getElementById('autocompleteNombre').value.toLowerCase();
            const departamento = document.getElementById('filtroDepartamento').value;
            const estado = document.getElementById('filtroEstado').value;
            const titularidad = document.getElementById('filtroTitularidad').value;
            
            // Filtros geogr√°ficos
            const latMin = parseFloat(document.getElementById('latMin').value);
            const latMax = parseFloat(document.getElementById('latMax').value);
            const lngMin = parseFloat(document.getElementById('lngMin').value);
            const lngMax = parseFloat(document.getElementById('lngMax').value);
            
            datosCompletos = datosOriginales.filter(item => {
                let cumple = true;
                
                // Filtro por nombre
                if (nombreBusqueda && !item.nombre.toLowerCase().includes(nombreBusqueda)) {
                    cumple = false;
                }
                
                // Filtro por departamento simple (solo si no hay m√∫ltiples seleccionados)
                if (departamento && departamentosSeleccionados.length === 0 && item.departamento !== departamento) {
                    cumple = false;
                }
                
                // Filtro por m√∫ltiples departamentos (tiene prioridad sobre el simple)
                if (departamentosSeleccionados.length > 0 && !departamentosSeleccionados.includes(item.departamento)) {
                    cumple = false;
                }
                
                // Filtro por estado
                if (estado && (!item.raw || item.raw.ESTADO !== estado)) {
                    cumple = false;
                }
                
                // Filtro por titularidad
                if (titularidad && (!item.raw || !item.raw.TITULARIDAD || !item.raw.TITULARIDAD.includes(titularidad))) {
                    cumple = false;
                }
                
                // Filtros geogr√°ficos
                if (!isNaN(latMin) && item.lat < latMin) cumple = false;
                if (!isNaN(latMax) && item.lat > latMax) cumple = false;
                if (!isNaN(lngMin) && item.lng < lngMin) cumple = false;
                if (!isNaN(lngMax) && item.lng > lngMax) cumple = false;
                
                return cumple;
            });
            
            cargarMarcadores();
            actualizarEstadisticas();
            actualizarContadorFiltros();
            
            // Registrar en historial si hay filtros activos
            const filtrosActivos = obtenerFiltrosActivos();
            const hayFiltros = Object.values(filtrosActivos).some(v => 
                (Array.isArray(v) && v.length > 0) || 
                (typeof v === 'object' && Object.values(v).some(x => x)) ||
                (typeof v === 'string' && v)
            );
            
            if (hayFiltros) {
                let detallesFiltro = [];
                if (filtrosActivos.nombre) detallesFiltro.push(`Nombre: ${filtrosActivos.nombre}`);
                if (filtrosActivos.departamento) detallesFiltro.push(`Depto: ${filtrosActivos.departamento}`);
                if (filtrosActivos.estado) detallesFiltro.push(`Estado: ${filtrosActivos.estado}`);
                if (departamentosSeleccionados.length > 0) detallesFiltro.push(`Multi-depto: ${departamentosSeleccionados.length}`);
                
                agregarAlHistorial('Filtros aplicados', detallesFiltro.join(', ') || 'Filtros complejos');
            }
        }
        
        // Actualizar contador de filtros
        function actualizarContadorFiltros() {
            const info = document.getElementById('infoFiltros');
            const contador = document.getElementById('contadorFiltros');
            
            contador.textContent = datosCompletos.length;
            info.style.display = 'block';
            
            // Color seg√∫n cantidad de resultados
            if (datosCompletos.length === 0) {
                info.style.background = '#f8d7da';
                info.style.borderColor = '#dc3545';
            } else if (datosCompletos.length < 10) {
                info.style.background = '#fff3cd';
                info.style.borderColor = '#ffc107';
            } else {
                info.style.background = '#e7f3ff';
                info.style.borderColor = '#0066cc';
            }
        }
        
        // Limpiar filtros avanzados
        function limpiarFiltrosAvanzados() {
            // Limpiar campos de texto
            document.getElementById('autocompleteNombre').value = '';
            document.getElementById('puntoReferencia').value = '';
            document.getElementById('radioKm').value = '';
            document.getElementById('latMin').value = '';
            document.getElementById('latMax').value = '';
            document.getElementById('lngMin').value = '';
            document.getElementById('lngMax').value = '';
            document.getElementById('multiDepartamentos').value = '';
            
            // Limpiar selects
            document.getElementById('filtroDepartamento').value = '';
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroTitularidad').value = '';
            
            // Limpiar arrays
            departamentosSeleccionados = [];
            
            // Ocultar sugerencias
            document.getElementById('sugerenciasNombre').style.display = 'none';
            document.getElementById('multiSelectDepartamentos').style.display = 'none';
            document.getElementById('infoFiltros').style.display = 'none';
            
            // Restaurar datos originales
            datosCompletos = [...datosOriginales];
            cargarMarcadores();
            actualizarEstadisticas();
        }
        
        // Filtros favoritos
        function guardarFiltrosFavoritos() {
            const nombre = prompt('Nombre para este filtro:');
            if (!nombre) return;
            
            const filtro = {
                nombre,
                nombreBusqueda: document.getElementById('autocompleteNombre').value,
                departamento: document.getElementById('filtroDepartamento').value,
                estado: document.getElementById('filtroEstado').value,
                titularidad: document.getElementById('filtroTitularidad').value,
                departamentosMultiples: [...departamentosSeleccionados],
                latMin: document.getElementById('latMin').value,
                latMax: document.getElementById('latMax').value,
                lngMin: document.getElementById('lngMin').value,
                lngMax: document.getElementById('lngMax').value
            };
            
            filtrosFavoritos.push(filtro);
            localStorage.setItem('filtrosFavoritos', JSON.stringify(filtrosFavoritos));
            poblarFiltrosFavoritos();
            
            alert(`Filtro "${nombre}" guardado correctamente`);
        }
        
        function poblarFiltrosFavoritos() {
            const select = document.getElementById('filtrosFavoritos');
            select.innerHTML = '<option value="">‚≠ê Filtros Favoritos</option>';
            
            filtrosFavoritos.forEach((filtro, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = filtro.nombre;
                select.appendChild(option);
            });
        }
        
        function cargarFiltroFavorito() {
            const select = document.getElementById('filtrosFavoritos');
            const index = select.value;
            
            if (index === '') return;
            
            const filtro = filtrosFavoritos[index];
            
            // Cargar valores del filtro
            document.getElementById('autocompleteNombre').value = filtro.nombreBusqueda;
            document.getElementById('filtroDepartamento').value = filtro.departamento;
            document.getElementById('filtroEstado').value = filtro.estado;
            document.getElementById('filtroTitularidad').value = filtro.titularidad;
            document.getElementById('latMin').value = filtro.latMin;
            document.getElementById('latMax').value = filtro.latMax;
            document.getElementById('lngMin').value = filtro.lngMin;
            document.getElementById('lngMax').value = filtro.lngMax;
            
            departamentosSeleccionados = [...filtro.departamentosMultiples];
            document.getElementById('multiDepartamentos').value = departamentosSeleccionados.length > 0 
                ? `${departamentosSeleccionados.length} departamentos seleccionados`
                : '';
            
            aplicarFiltrosAvanzados();
        }
        
        // Limpiar filtros (funci√≥n original mantenida por compatibilidad)
        function limpiarFiltros() {
            limpiarFiltrosAvanzados();
        }
        
        // ========== FUNCIONES DE EXPORT ==========
        function exportarDatos(formato) {
            if (datosCompletos.length === 0) {
                alert('No hay datos para exportar. Aplica filtros primero.');
                return;
            }
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
            const nombreArchivo = `infraestructura_${formato}_${timestamp}`;
            
            switch (formato) {
                case 'csv':
                    exportarCSV(nombreArchivo);
                    break;
                case 'json':
                    exportarJSON(nombreArchivo);
                    break;
                case 'kml':
                    exportarKML(nombreArchivo);
                    break;
            }
            
            // Registrar en historial
            agregarAlHistorial(`Export ${formato.toUpperCase()}`, `${datosCompletos.length} registros exportados`);
        }
        
        function exportarCSV(nombreArchivo) {
            const headers = ['Nombre', 'Tipo', 'Departamento', 'Estado', 'Titularidad', 'Latitud', 'Longitud'];
            let csvContent = headers.join(',') + '\n';
            
            datosCompletos.forEach(item => {
                const row = [
                    `"${item.nombre}"`,
                    `"${item.tipo}"`,
                    `"${item.departamento}"`,
                    `"${item.raw.ESTADO || ''}"`,
                    `"${item.raw.TITULARIDAD || ''}"`,
                    item.lat,
                    item.lng
                ];
                csvContent += row.join(',') + '\n';
            });
            
            descargarArchivo(csvContent, nombreArchivo + '.csv', 'text/csv');
        }
        
        function exportarJSON(nombreArchivo) {
            const jsonData = {
                metadata: {
                    timestamp: new Date().toISOString(),
                    total_registros: datosCompletos.length,
                    filtros_aplicados: obtenerFiltrosActivos()
                },
                datos: datosCompletos.map(item => ({
                    nombre: item.nombre,
                    tipo: item.tipo,
                    departamento: item.departamento,
                    coordenadas: {
                        latitud: item.lat,
                        longitud: item.lng
                    },
                    estado: item.raw.ESTADO,
                    titularidad: item.raw.TITULARIDAD,
                    datos_completos: item.raw
                }))
            };
            
            descargarArchivo(JSON.stringify(jsonData, null, 2), nombreArchivo + '.json', 'application/json');
        }
        
        function exportarKML(nombreArchivo) {
            let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Infraestructura Per√∫</name>
    <description>Exportado desde Dashboard de Infraestructura</description>
    
    <!-- Estilos -->
    <Style id="puerto_style">
      <IconStyle>
        <Icon><href>http://maps.google.com/mapfiles/kml/paddle/blu-circle.png</href></Icon>
      </IconStyle>
    </Style>
    <Style id="aeropuerto_style">
      <IconStyle>
        <Icon><href>http://maps.google.com/mapfiles/kml/paddle/orange-circle.png</href></Icon>
      </IconStyle>
    </Style>
    <Style id="ferroviaria_style">
      <IconStyle>
        <Icon><href>http://maps.google.com/mapfiles/kml/paddle/brown-circle.png</href></Icon>
      </IconStyle>
    </Style>
`;
            
            datosCompletos.forEach(item => {
                if (!isNaN(item.lat) && !isNaN(item.lng)) {
                    kmlContent += `
    <Placemark>
      <name>${item.nombre}</name>
      <description><![CDATA[
        <b>Tipo:</b> ${item.tipo}<br>
        <b>Departamento:</b> ${item.departamento}<br>
        <b>Estado:</b> ${item.raw.ESTADO || 'N/A'}<br>
        <b>Titularidad:</b> ${item.raw.TITULARIDAD || 'N/A'}
      ]]></description>
      <styleUrl>#${item.tipo}_style</styleUrl>
      <Point>
        <coordinates>${item.lng},${item.lat},0</coordinates>
      </Point>
    </Placemark>`;
                }
            });
            
            kmlContent += `
  </Document>
</kml>`;
            
            descargarArchivo(kmlContent, nombreArchivo + '.kml', 'application/vnd.google-earth.kml+xml');
        }
        
        function descargarArchivo(contenido, nombreArchivo, tipoMime) {
            const blob = new Blob([contenido], { type: tipoMime });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function obtenerFiltrosActivos() {
            return {
                nombre: document.getElementById('autocompleteNombre').value,
                departamento: document.getElementById('filtroDepartamento').value,
                estado: document.getElementById('filtroEstado').value,
                titularidad: document.getElementById('filtroTitularidad').value,
                departamentos_multiples: departamentosSeleccionados,
                coordenadas: {
                    lat_min: document.getElementById('latMin').value,
                    lat_max: document.getElementById('latMax').value,
                    lng_min: document.getElementById('lngMin').value,
                    lng_max: document.getElementById('lngMax').value
                }
            };
        }
        
        // ========== FUNCIONES DE ESTAD√çSTICAS AVANZADAS ==========
        function toggleEstadisticasAvanzadas() {
            const panel = document.getElementById('estadisticasAvanzadas');
            const isVisible = panel.style.display !== 'none';
            
            if (isVisible) {
                panel.style.display = 'none';
            } else {
                actualizarEstadisticasAvanzadas();
                panel.style.display = 'block';
            }
        }
        
        function actualizarEstadisticasAvanzadas() {
            const puertos = datosCompletos.filter(d => d.tipo === 'puerto').length;
            const aeropuertos = datosCompletos.filter(d => d.tipo === 'aeropuerto').length;
            const ferroviarias = datosCompletos.filter(d => d.tipo === 'ferroviaria').length;
            
            // Depuraci√≥n: mostrar departamentos √∫nicos
            const departamentosUnicos = new Set(datosCompletos.map(d => d.departamento).filter(d => d && d.trim() !== ''));
            const departamentos = departamentosUnicos.size;
            
            // Contar estados solo si existen
            const operativos = datosCompletos.filter(d => d.raw && d.raw.ESTADO === 'Operativo').length;
            const inoperativos = datosCompletos.filter(d => d.raw && (d.raw.ESTADO === 'Inoperativo' || d.raw.ESTADO === 'Clausurado')).length;
            
            document.getElementById('statPuertos').textContent = puertos;
            document.getElementById('statAeropuertos').textContent = aeropuertos;
            document.getElementById('statFerroviarias').textContent = ferroviarias;
            document.getElementById('statDepartamentos').textContent = departamentos;
            document.getElementById('statOperativos').textContent = operativos;
            document.getElementById('statInoperativos').textContent = inoperativos;
        }
        
        // ========== FUNCIONES DE HISTORIAL ==========
        function agregarAlHistorial(accion, detalle) {
            const entrada = {
                timestamp: new Date().toLocaleString(),
                accion: accion,
                detalle: detalle,
                resultados: datosCompletos.length
            };
            
            historialBusquedas.unshift(entrada);
            
            // Mantener solo las √∫ltimas 10 b√∫squedas
            if (historialBusquedas.length > 10) {
                historialBusquedas = historialBusquedas.slice(0, 10);
            }
            
            localStorage.setItem('historialBusquedas', JSON.stringify(historialBusquedas));
            actualizarVistaHistorial();
        }
        
        function actualizarVistaHistorial() {
            const contenedor = document.getElementById('historialBusquedas');
            
            if (historialBusquedas.length === 0) {
                contenedor.innerHTML = '<div style="color: #666; font-size: 0.9rem;">No hay b√∫squedas recientes</div>';
                return;
            }
            
            let html = '';
            historialBusquedas.forEach((entrada, index) => {
                html += `<div style="padding: 5px; border-bottom: 1px solid #ddd; cursor: pointer; font-size: 0.8rem;" 
                            onclick="repetirBusqueda(${index})"
                            onmouseover="this.style.background='#f0f6ff'" 
                            onmouseout="this.style.background='transparent'">
                    <strong>${entrada.accion}</strong> - ${entrada.detalle}<br>
                    <span style="color: #666;">${entrada.timestamp} (${entrada.resultados} resultados)</span>
                </div>`;
            });
            
            contenedor.innerHTML = html;
        }
        
        function repetirBusqueda(index) {
            // Esta funci√≥n podr√≠a implementarse para repetir b√∫squedas anteriores
            alert('Funci√≥n de repetir b√∫squeda en desarrollo. Entrada: ' + historialBusquedas[index].accion);
        }
        
        function limpiarHistorial() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el historial?')) {
                historialBusquedas = [];
                localStorage.removeItem('historialBusquedas');
                actualizarVistaHistorial();
            }
        }
        
        // ========== FUNCIONES DE DIBUJO DE √ÅREAS ==========
        function toggleModoAreaDrawing() {
            modoAreaDrawing = !modoAreaDrawing;
            const btnDibujar = document.getElementById('btnDibujar');
            
            if (modoAreaDrawing) {
                mapa.on('click', onMapaClick);
                mapa.getContainer().style.cursor = 'crosshair';
                btnDibujar.innerHTML = '<i class="fas fa-times"></i> Cancelar Dibujo';
                btnDibujar.style.background = '#dc3545';
                alert('Modo dibujo activado. Haz clic en el mapa para crear un √°rea de filtro de 10km.');
            } else {
                mapa.off('click', onMapaClick);
                mapa.getContainer().style.cursor = '';
                btnDibujar.innerHTML = '<i class="fas fa-draw-polygon"></i> Activar Dibujo';
                btnDibujar.style.background = '#e83e8c';
            }
        }
        
        function onMapaClick(e) {
            if (!modoAreaDrawing) return;
            
            // Crear un c√≠rculo de 10km radius
            const circle = L.circle([e.latlng.lat, e.latlng.lng], {
                color: '#ff6b6b',
                fillColor: '#ff6b6b',
                fillOpacity: 0.2,
                radius: 10000 // 10km
            }).addTo(mapa);
            
            areasMapaDibujadas.push({
                centro: e.latlng,
                radio: 10,
                layer: circle
            });
            
            // Filtrar datos dentro del √°rea
            filtrarPorAreasDibujadas();
            toggleModoAreaDrawing(); // Desactivar modo despu√©s de dibujar
        }
        
        function filtrarPorAreasDibujadas() {
            if (areasMapaDibujadas.length === 0) return;
            
            datosCompletos = datosOriginales.filter(item => {
                if (isNaN(item.lat) || isNaN(item.lng)) return false;
                
                return areasMapaDibujadas.some(area => {
                    const distancia = distanciaKm(area.centro.lat, area.centro.lng, item.lat, item.lng);
                    return distancia <= area.radio;
                });
            });
            
            cargarMarcadores();
            actualizarEstadisticas();
            actualizarContadorFiltros();
            
            agregarAlHistorial('Filtro por √°rea', `${areasMapaDibujadas.length} √°rea(s) dibujada(s)`);
        }
        
        function limpiarAreasDibujadas() {
            areasMapaDibujadas.forEach(area => {
                mapa.removeLayer(area.layer);
            });
            areasMapaDibujadas = [];
            
            // Restaurar datos
            datosCompletos = [...datosOriginales];
            cargarMarcadores();
            actualizarEstadisticas();
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos().then(() => {
                poblarFiltros();
                poblarFiltrosFavoritos();
                actualizarVistaHistorial();
                crearGraficos();
            });
        });

        // Consultas avanzadas
        function buscarNombre() {
            const val = document.getElementById('busquedaInput').value.trim();
            if (!val) return;
            document.getElementById('resultadoConsulta').innerHTML = '<div class="loading"><div class="spinner"></div>Buscando...</div>';
            fetch(`api_consultas.php?search=${encodeURIComponent(val)}`)
                .then(r => r.json())
                .then(data => {
                    if (!data.length) {
                        document.getElementById('resultadoConsulta').innerHTML = '<div class="error">No se encontraron resultados.</div>';
                        datosCompletos = [];
                        cargarMarcadores();
                        actualizarEstadisticas();
                        return;
                    }
                    let html = '<div style="overflow-x:auto;"><table><tr>';
                    html += '<th></th>';
                    for (let key in data[0]) html += `<th>${key}</th>`;
                    html += '</tr>';
                    data.forEach(row => {
                        html += '<tr>';
                        let icono = '‚ö™';
                        if (row.tipo === 'puerto') icono = '‚õ¥Ô∏è';
                        else if (row.tipo === 'aeropuerto') icono = '‚úàÔ∏è';
                        else if (row.tipo === 'ferroviaria') icono = 'üöÇ';
                        html += `<td class="icon-cell">${icono}</td>`;
                        for (let key in data[0]) html += `<td>${row[key]}</td>`;
                        html += '</tr>';
                    });
                    html += '</table></div>';
                    document.getElementById('resultadoConsulta').innerHTML = html;
                    document.getElementById('resultadoConsulta').scrollIntoView({behavior:'smooth'});
                    // Mostrar solo estos puntos en el mapa
                    datosCompletos = data.map(item => {
                        let nombre = item.NOMBRE || item.nombre || '';
                        let departamento = '';
                        if (item.tipo === 'puerto') {
                            departamento = (item.LOCALIDAD || '').trim();
                        } else {
                            departamento = (item.DEPARTAMENTO || '').trim();
                        }
                        
                        // Normalizar algunos departamentos comunes con variaciones
                        departamento = normalizarDepartamento(departamento);
                        let lat = parseFloat(item.LATITUD);
                        let lng = parseFloat(item.LONGITUD);
                        return {
                            tipo: item.tipo,
                            nombre,
                            departamento,
                            lat,
                            lng,
                            raw: item
                        };
                    });
                    cargarMarcadores();
                    actualizarEstadisticas();
                })
                .catch(() => {
                    document.getElementById('resultadoConsulta').innerHTML = '<div class="error">Error en la consulta.</div>';
                    datosCompletos = [];
                    cargarMarcadores();
                    actualizarEstadisticas();
                });
        }
        function consultaStat(tipo) {
            document.getElementById('resultadoConsulta').innerHTML = '<div class="loading"><div class="spinner"></div>Consultando estad√≠sticas...</div>';
            fetch(`api_consultas.php?stat=${tipo}`)
                .then(r => r.json())
                .then(data => {
                    if (!data.length) {
                        document.getElementById('resultadoConsulta').innerHTML = '<div class="error">No hay datos para mostrar.</div>';
                        return;
                    }
                    
                    // Crear tabla de estad√≠sticas mejorada
                    let html = `<div style="overflow-x:auto; max-height: 400px;">
                        <h4>üìä Estad√≠sticas: ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; position: sticky; top: 0;">`;
                    
                    // Headers de la tabla
                    for (let key in data[0]) {
                        const headerName = key.charAt(0).toUpperCase() + key.slice(1);
                        html += `<th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">${headerName}</th>`;
                    }
                    html += `<th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Porcentaje</th></tr>
                            </thead>
                            <tbody>`;
                    
                    // Calcular total para porcentajes
                    const total = data.reduce((sum, row) => sum + (row.total || 0), 0);
                    
                    // Ordenar datos por total (descendente)
                    data.sort((a, b) => (b.total || 0) - (a.total || 0));
                    
                    // Filas de datos
                    data.forEach((row, index) => {
                        const porcentaje = total > 0 ? ((row.total / total) * 100).toFixed(1) : '0.0';
                        html += `<tr style="border-bottom: 1px solid #dee2e6; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">`;
                        
                        for (let key in row) {
                            const value = row[key];
                            const cellStyle = key === 'total' ? 'font-weight: bold; color: #0066cc;' : '';
                            html += `<td style="padding: 10px; ${cellStyle}">${value}</td>`;
                        }
                        
                        html += `<td style="padding: 10px; font-weight: bold; color: #28a745;">${porcentaje}%</td>`;
                        html += '</tr>';
                    });
                    
                    html += `</tbody></table>
                        <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                            <strong>üìà Total de registros:</strong> ${total}
                        </div>
                    </div>`;
                    
                    document.getElementById('resultadoConsulta').innerHTML = html;
                    document.getElementById('resultadoConsulta').scrollIntoView({behavior:'smooth'});
                    
                    // Agregar al historial
                    agregarAlHistorial(`Estad√≠sticas: ${tipo}`, `${data.length} categor√≠as encontradas`);
                })
                .catch(err => {
                    console.error('Error en consultaStat:', err);
                    document.getElementById('resultadoConsulta').innerHTML = '<div class="error">Error en la consulta estad√≠stica.</div>';
                });
        }
        function refrescarMapa() {
            datosCompletos = [...datosOriginales];
            cargarMarcadores();
            actualizarEstadisticas();
            document.getElementById('resultadoConsulta').innerHTML = '';
            document.getElementById('busquedaInput').value = '';
        }
        
        // Nuevas funciones para manejo optimizado de datos
        function actualizarControlesPaginacion(registrosCargados, cargarTodo) {
            const info = document.getElementById('infoRegistros');
            const btnCargarMas = document.getElementById('btnCargarMas');
            
            if (cargarTodo) {
                info.innerHTML = `Registros cargados: ${datosCompletos.length} (TODOS)`;
                btnCargarMas.style.display = 'none';
            } else {
                info.innerHTML = `Registros cargados: ${datosCompletos.length} (P√°gina ${paginaActual})`;
                btnCargarMas.style.display = registrosCargados >= limitePorPagina ? 'inline-block' : 'none';
            }
        }
        
        function cargarMasDatos() {
            cargarDatos(paginaActual + 1, limitePorPagina, false);
        }
        
        function confirmarCargarTodo() {
            if (confirm('‚ö†Ô∏è ADVERTENCIA: Cargar TODOS los datos puede ser muy lento y consumir mucha RAM.\n\n¬øEst√°s seguro de continuar?')) {
                cargarDatos(1, 0, true);
            }
        }
        
        function limpiarDatos() {
            datosCompletos = [];
            datosOriginales = [];
            marcadores.forEach(marker => mapa.removeLayer(marker));
            marcadores = [];
            limpiarLineasFerroviarias();
            actualizarEstadisticas();
            document.getElementById('infoRegistros').innerHTML = 'Registros cargados: 0';
            document.getElementById('btnCargarMas').style.display = 'none';
        }

        // Funciones avanzadas de BD
        function ejecutarTransaccion() {
            document.getElementById('resultadoAvanzado').innerHTML = '<div class="loading"><div class="spinner"></div>Ejecutando transacci√≥n simulada...</div>';
            
            // Simular transacci√≥n compleja
            setTimeout(() => {
                fetch('transacciones_simuladas.php')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('resultadoAvanzado').innerHTML = html;
                        document.getElementById('resultadoAvanzado').scrollIntoView({behavior: 'smooth'});
                        
                        // Registrar actividad
                        registrarActividad('ejecutar_transaccion', 'funcionalidades_avanzadas', 'Transacci√≥n simulada ejecutada exitosamente');
                    })
                    .catch(error => {
                        document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error al ejecutar transacci√≥n: ' + error.message + '</div>';
                    });
            }, 1000);
        }

        function validarIntegridad() {
            document.getElementById('resultadoAvanzado').innerHTML = '<div class="loading"><div class="spinner"></div>Validando integridad de datos...</div>';
            
            fetch('sistema_auditoria.php?action=validar_integridad')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const v = data.validaciones;
                        let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">';
                        html += '<h4>üìã Validaci√≥n de Integridad de Datos Completa</h4>';
                        html += '<p><strong>Timestamp:</strong> ' + data.timestamp + '</p>';
                        
                        // Estad√≠sticas generales
                        html += '<div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0;">';
                        html += '<h5>üìà Estad√≠sticas Generales</h5>';
                        html += '<p><strong>Total Puertos:</strong> ' + v.total_puertos + '</p>';
                        html += '<p><strong>Total Aeropuertos:</strong> ' + v.total_aeropuertos + '</p>';
                        html += '<p><strong>Total Ferroviarias:</strong> ' + v.total_ferroviarias + '</p>';
                        html += '<p><strong>Calidad General:</strong> <span style="color: ' + (v.porcentaje_calidad > 90 ? 'green' : v.porcentaje_calidad > 70 ? 'orange' : 'red') + '; font-weight: bold;">' + v.porcentaje_calidad + '%</span></p>';
                        html += '</div>';
                        
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">';
                        
                        html += '<div style="background: ' + (v.coordenadas_invalidas > 0 ? '#fff3cd' : '#d4edda') + '; padding: 10px; border-radius: 5px;">';
                        html += '<h5>üó∫Ô∏è Coordenadas</h5>';
                        html += '<p><strong>Coordenadas inv√°lidas:</strong> ' + v.coordenadas_invalidas + '</p>';
                        html += '<p><strong>Estado:</strong> ' + (v.coordenadas_invalidas > 0 ? '‚ö†Ô∏è Requiere atenci√≥n' : '‚úÖ Correctas') + '</p>';
                        html += '</div>';
                        
                        html += '<div style="background: ' + (v.duplicados_total > 0 ? '#fff3cd' : '#d4edda') + '; padding: 10px; border-radius: 5px;">';
                        html += '<h5>üîÑ Duplicados</h5>';
                        html += '<p><strong>Puertos:</strong> ' + (v.puertos_duplicados || 0) + '</p>';
                        html += '<p><strong>Aeropuertos:</strong> ' + (v.aeropuertos_duplicados || 0) + '</p>';
                        html += '<p><strong>Estado:</strong> ' + (v.duplicados_total > 0 ? '‚ö†Ô∏è Requiere limpieza' : '‚úÖ Sin duplicados') + '</p>';
                        html += '</div>';
                        
                        html += '<div style="background: ' + (v.datos_faltantes > 0 ? '#f8d7da' : '#d4edda') + '; padding: 10px; border-radius: 5px;">';
                        html += '<h5>üìù Datos Faltantes</h5>';
                        html += '<p><strong>Puertos incompletos:</strong> ' + (v.puertos_faltantes || 0) + '</p>';
                        html += '<p><strong>Aeropuertos incompletos:</strong> ' + (v.aeropuertos_faltantes || 0) + '</p>';
                        html += '<p><strong>Estado:</strong> ' + (v.datos_faltantes > 0 ? '‚ùå Requiere completar' : '‚úÖ Completos') + '</p>';
                        html += '</div>';
                        
                        html += '</div>';
                        
                        // Problema espec√≠fico de ferroviarias
                        html += '<div style="background: ' + (v.ferroviarias_sin_latitud > 0 ? '#fff3cd' : '#d4edda') + '; padding: 15px; border-radius: 5px; margin: 15px 0;">';
                        html += '<h5>üöÇ Problema Espec√≠fico: Ferroviarias</h5>';
                        html += '<p><strong>Ferroviarias sin LATITUD:</strong> ' + (v.ferroviarias_sin_latitud || 0) + ' / ' + v.total_ferroviarias + '</p>';
                        html += '<p><strong>Explicaci√≥n:</strong> Este es el problema que mencionaste - las ferroviarias solo tienen LONGITUD, no LATITUD</p>';
                        html += '<p><strong>Impacto:</strong> Estos puntos aparecen mal ubicados en el mapa (en plazas, lagos, etc.)</p>';
                        if (v.ferroviarias_sin_latitud > 0) {
                            html += '<p style="color: orange;"><strong>Recomendaci√≥n:</strong> Asignar coordenadas aproximadas por departamento o corregir datos fuente</p>';
                        }
                        html += '</div>';
                        
                        html += '<div style="background: #e7f3ff; padding: 10px; border-radius: 5px;">';
                        html += '<h5>üìä Resumen Final</h5>';
                        const total_issues = v.coordenadas_invalidas + v.duplicados_total + v.datos_faltantes;
                        html += '<p><strong>Total de problemas detectados:</strong> ' + total_issues + '</p>';
                        html += '<p><strong>Calidad general de datos:</strong> ' + (total_issues === 0 ? '‚úÖ Excelente' : (total_issues < 10 ? '‚ö†Ô∏è Buena' : '‚ùå Requiere mejoras')) + '</p>';
                        html += '</div>';
                        
                        html += '</div>';
                        
                        document.getElementById('resultadoAvanzado').innerHTML = html;
                    } else {
                        document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error en validaci√≥n: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
                });
        }

        function generarBackup() {
            document.getElementById('resultadoAvanzado').innerHTML = '<div class="loading"><div class="spinner"></div>Generando backup...</div>';
            
            fetch('sistema_auditoria.php?action=backup_datos')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let html = '<div style="background: #d4edda; padding: 15px; border-radius: 8px;">';
                        html += '<h4>üíæ Backup Generado Exitosamente</h4>';
                        html += '<p><strong>ID del Backup:</strong> <code>' + data.backup_id + '</code></p>';
                        html += '<p><strong>Timestamp:</strong> ' + data.timestamp + '</p>';
                        
                        html += '<div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 15px 0;">';
                        html += '<h5>üìä Estad√≠sticas del Backup</h5>';
                        if (data.estadisticas) {
                            html += '<p><strong>Total de registros:</strong> ' + data.estadisticas.total_registros + '</p>';
                            html += '<p><strong>Tama√±o estimado:</strong> ' + data.estadisticas.tama√±o_estimado + '</p>';
                            html += '<p><strong>Tiempo estimado:</strong> ' + data.estadisticas.tiempo_estimado + '</p>';
                            html += '<p><strong>Compresi√≥n:</strong> ' + data.estadisticas.compresion + '</p>';
                        }
                        html += '</div>';
                        
                        html += '<div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 15px 0;">';
                        html += '<h5>üì¶ Datos Respaldados</h5>';
                        html += '<ul style="margin: 0; padding-left: 20px;">';
                        data.datos_respaldados.forEach(dato => {
                            html += '<li>‚úÖ ' + dato + '</li>';
                        });
                        html += '</ul>';
                        html += '</div>';
                        
                        html += '<p style="color: #666; font-style: italic; margin-top: 15px;">';
                        html += '<strong>Nota:</strong> El backup se guard√≥ en formato JSON comprimido con metadatos completos';
                        html += '</p>';
                        html += '</div>';
                        
                        document.getElementById('resultadoAvanzado').innerHTML = html;
                    } else {
                        document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error al generar backup: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
                });
        }

        function medirRendimiento() {
            document.getElementById('resultadoAvanzado').innerHTML = '<div class="loading"><div class="spinner"></div>Midiendo rendimiento...</div>';
            
            fetch('sistema_auditoria.php?action=performance_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const perf = data.data;
                        let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">';
                        html += '<h4>‚ö° Estad√≠sticas de Rendimiento</h4>';
                        html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">';
                        
                        html += '<div style="background: #e7f3ff; padding: 10px; border-radius: 5px;">';
                        html += '<h5>‚è±Ô∏è Tiempo de Ejecuci√≥n</h5>';
                        html += '<p><strong>' + perf.tiempo_carga_ms + ' ms</strong></p>';
                        html += '<p>Estado: ' + (perf.tiempo_carga_ms < 100 ? '‚úÖ Excelente' : (perf.tiempo_carga_ms < 500 ? '‚ö†Ô∏è Bueno' : '‚ùå Lento')) + '</p>';
                        html += '</div>';
                        
                        html += '<div style="background: #fff3cd; padding: 10px; border-radius: 5px;">';
                        html += '<h5>üß† Memoria Utilizada</h5>';
                        html += '<p><strong>' + perf.memoria_usada + '</strong></p>';
                        html += '<p>Estado: ' + (parseFloat(perf.memoria_usada) < 10 ? '‚úÖ Eficiente' : (parseFloat(perf.memoria_usada) < 50 ? '‚ö†Ô∏è Moderado' : '‚ùå Alto')) + '</p>';
                        html += '</div>';
                        
                        html += '<div style="background: #d4edda; padding: 10px; border-radius: 5px;">';
                        html += '<h5>üìä Registros Procesados</h5>';
                        html += '<p><strong>' + perf.registros_procesados + '</strong></p>';
                        html += '<p>Consulta: Agregaci√≥n por departamento</p>';
                        html += '</div>';
                        
                        html += '<div style="background: #f8d7da; padding: 10px; border-radius: 5px;">';
                        html += '<h5>‚è∞ Timestamp</h5>';
                        html += '<p><strong>' + perf.timestamp + '</strong></p>';
                        html += '<p>Tipo: Benchmark autom√°tico</p>';
                        html += '</div>';
                        
                        html += '</div>';
                        
                        // Mostrar algunos resultados de la consulta
                        if (data.datos && data.datos.length > 0) {
                            html += '<h5>üìã Muestra de Resultados (Top 5)</h5>';
                            html += '<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">';
                            html += '<tr><th>Departamento</th><th>Total Puertos</th><th>Total Toneladas</th><th>Promedio</th></tr>';
                            data.datos.slice(0, 5).forEach(row => {
                                html += '<tr>';
                                html += '<td>' + row._id + '</td>';
                                html += '<td>' + row.total_puertos + '</td>';
                                html += '<td>' + (row.total_toneladas || 0).toLocaleString() + '</td>';
                                html += '<td>' + (row.promedio_toneladas || 0).toLocaleString() + '</td>';
                                html += '</tr>';
                            });
                            html += '</table>';
                        }
                        
                        html += '</div>';
                        
                        document.getElementById('resultadoAvanzado').innerHTML = html;
                    } else {
                        document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error en medici√≥n: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
                });
        }

        function verProcedimientos() {
            document.getElementById('resultadoAvanzado').innerHTML = '<div class="loading"><div class="spinner"></div>Cargando procedimientos...</div>';
            
            setTimeout(() => {
                fetch('procedimientos.php')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('resultadoAvanzado').innerHTML = html;
                        document.getElementById('resultadoAvanzado').scrollIntoView({behavior: 'smooth'});
                    })
                    .catch(error => {
                        document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error al cargar procedimientos: ' + error.message + '</div>';
                    });
            }, 800);
        }

        function mostrarLogs() {
            document.getElementById('resultadoAvanzado').innerHTML = '<div class="loading"><div class="spinner"></div>Cargando logs del sistema...</div>';
            
            fetch('sistema_auditoria.php?action=obtener_logs_sistema')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">';
                        html += '<h4>üìÑ Logs del Sistema</h4>';
                        html += '<p><strong>√öltimos 20 registros</strong></p>';
                        
                        if (data.data && data.data.length > 0) {
                            html += '<table style="width: 100%; border-collapse: collapse; margin: 10px 0; border: 1px solid #dee2e6;">';
                            html += '<tr style="background: #f8f9fa;"><th style="padding: 8px; border: 1px solid #dee2e6;">Timestamp</th><th style="padding: 8px; border: 1px solid #dee2e6;">Nivel</th><th style="padding: 8px; border: 1px solid #dee2e6;">Usuario</th><th style="padding: 8px; border: 1px solid #dee2e6;">Mensaje</th></tr>';
                            
                            data.data.forEach(log => {
                                html += '<tr>';
                                html += '<td style="padding: 8px; border: 1px solid #dee2e6;">' + log.timestamp + '</td>';
                                html += '<td style="padding: 8px; border: 1px solid #dee2e6; color: ' + (log.nivel === 'INFO' ? '#28a745' : log.nivel === 'WARNING' ? '#ffc107' : '#dc3545') + '; font-weight: bold;">' + log.nivel + '</td>';
                                html += '<td style="padding: 8px; border: 1px solid #dee2e6;">' + log.usuario + '</td>';
                                html += '<td style="padding: 8px; border: 1px solid #dee2e6;">' + (log.mensaje || 'N/A') + '</td>';
                                html += '</tr>';
                            });
                            
                            html += '</table>';
                        } else {
                            html += '<p>No hay logs disponibles</p>';
                        }
                        
                        html += '</div>';
                        
                        document.getElementById('resultadoAvanzado').innerHTML = html;
                    } else {
                        document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error al obtener logs: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('resultadoAvanzado').innerHTML = '<div class="error">Error: ' + error.message + '</div>';
                });
        }

        // Registrar actividad del usuario
        function registrarActividad(accion, seccion, detalles) {
            const formData = new FormData();
            formData.append('usuario', 'usuario_dashboard');
            formData.append('accion', accion);
            formData.append('seccion', seccion);
            formData.append('detalles', detalles);
            
            fetch('sistema_auditoria.php?action=registrar_actividad', {
                method: 'POST',
                body: formData
            }).catch(error => {
                console.log('Error registrando actividad:', error);
            });
        }
    </script>
    <!-- Fondo animado de estrellas y emojis de transporte interactivo -->
    <script>
        // Fondo animado de estrellas y emojis de transporte interactivo
        // --- ESTRELLAS (opcional, puedes comentar si solo quieres emojis) ---
        const starsContainer = document.getElementById('stars');
        const numStars = 100;
        function resizeStarsContainer() {
            starsContainer.style.height = document.body.scrollHeight + 'px';
        }
        resizeStarsContainer();
        window.addEventListener('resize', resizeStarsContainer);
        window.addEventListener('scroll', resizeStarsContainer);
        if (starsContainer.childElementCount === 0) {
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}vw`;
                star.style.top = `${Math.random() * 100}vh`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                starsContainer.appendChild(star);
            }
        }

        // --- EMOJIS INTERACTIVOS ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = document.body.scrollHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('scroll', resizeCanvas);

        const nodes = [];
        const numNodes = 20;
        let selectedNode = null;

        class Node {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.targetX = this.x;
                this.targetY = this.y;
                this.vx = (Math.random() - 0.5) * 1.5;
                this.vy = (Math.random() - 0.5) * 1.5;
                this.emoji = Math.random() > 0.5 ? 'üö¢' : '‚úàÔ∏è';
                this.size = 24;
                this.isDragging = false;
            }
            update() {
                if (this.isDragging) {
                    // Suavizar movimiento hacia la posici√≥n objetivo
                    this.x = lerp(this.x, this.targetX, 0.2);
                    this.y = lerp(this.y, this.targetY, 0.2);
                } else {
                    this.x += this.vx;
                    this.y += this.vy;
                    // Rebote en los bordes con fricci√≥n
                    if (this.x < 0 || this.x > canvas.width) {
                        this.vx *= -0.8;
                        this.x = Math.max(0, Math.min(this.x, canvas.width));
                    }
                    if (this.y < 0 || this.y > canvas.height) {
                        this.vy *= -0.8;
                        this.y = Math.max(0, Math.min(this.y, canvas.height));
                    }
                }
            }
            draw() {
                ctx.font = `${this.size}px Arial`;
                ctx.fillText(this.emoji, this.x - this.size / 2, this.y + this.size / 2);
            }
            isClicked(mx, my) {
                const dx = mx - this.x;
                const dy = my - this.y;
                return Math.sqrt(dx * dx + dy * dy) < this.size * 1.5;
            }
        }
        function lerp(start, end, t) {
            return start + (end - start) * t;
        }
        if (nodes.length === 0) {
            for (let i = 0; i < numNodes; i++) {
                nodes.push(new Node());
            }
        }
        function connectNodes() {
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const dx = nodes[i].x - nodes[j].x;
                    const dy = nodes[i].y - nodes[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 200) {
                        ctx.beginPath();
                        ctx.strokeStyle = `rgba(0, 170, 255, ${0.4 - distance / 500})`;
                        ctx.lineWidth = 1;
                        ctx.moveTo(nodes[i].x, nodes[i].y);
                        ctx.lineTo(nodes[j].x, nodes[j].y);
                        ctx.stroke();
                    }
                }
            }
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            nodes.forEach(node => {
                node.update();
                node.draw();
            });
            connectNodes();
            requestAnimationFrame(animate);
        }
        animate();
        // --- Eventos de mouse/touch para arrastrar ---
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            nodes.forEach(node => {
                if (node.isClicked(mx, my)) {
                    selectedNode = node;
                    selectedNode.isDragging = true;
                    selectedNode.targetX = mx;
                    selectedNode.targetY = my;
                }
            });
        });
        canvas.addEventListener('mousemove', (e) => {
            if (selectedNode) {
                const rect = canvas.getBoundingClientRect();
                selectedNode.targetX = e.clientX - rect.left;
                selectedNode.targetY = e.clientY - rect.top;
            }
        });
        canvas.addEventListener('mouseup', () => {
            if (selectedNode) {
                selectedNode.isDragging = false;
                selectedNode.vx = (Math.random() - 0.5) * 1.2;
                selectedNode.vy = (Math.random() - 0.5) * 1.2;
                selectedNode = null;
            }
        });
        // Soporte para dispositivos t√°ctiles
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mx = e.touches[0].clientX - rect.left;
            const my = e.touches[0].clientY - rect.top;
            nodes.forEach(node => {
                if (node.isClicked(mx, my)) {
                    selectedNode = node;
                    selectedNode.isDragging = true;
                    selectedNode.targetX = mx;
                    selectedNode.targetY = my;
                }
            });
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (selectedNode) {
                const rect = canvas.getBoundingClientRect();
                selectedNode.targetX = e.touches[0].clientX - rect.left;
                selectedNode.targetY = e.touches[0].clientY - rect.top;
            }
        });
        canvas.addEventListener('touchend', () => {
            if (selectedNode) {
                selectedNode.isDragging = false;
                selectedNode.vx = (Math.random() - 0.5) * 1.2;
                selectedNode.vy = (Math.random() - 0.5) * 1.2;
                selectedNode = null;
            }
        });
    </script>
</body>
</html>